|     Feature     |                   Cookie                   |            localStorage            |      sessionStorage      |         indexDB          |
| :----------: | :----------------------------------------: | :--------------------------------: | :----------------------: | :----------------------: |
|   Lifecycle   |     Generally generated by server, can set expiration time     | Set by frontend, persists unless cleared | Set by frontend, cleared when page closes | Persists unless cleared |
| Storage Size | 4K | 5M | 5M | Unlimited |
| Server Communication | Carried in header with each request, affects request performance | Not involved | Not involved | Not involved |

## Cookie

`Cookie` was not originally designed for local storage, but rather to compensate for **HTTP's lack of state management**.

Cookie is essentially a small text file stored in the browser, internally storing data as key-value pairs (visible in the `Application` tab of Chrome developer tools). Requests to the same domain will carry the same Cookie, allowing the server to parse it and obtain the client's state. Different browsers have different limits on the number of cookies stored for the same domain.

**Important Cookie Attributes**

|      Attribute      | Description                                                         |
| :------------: | :----------------------------------------------------------- |
| **name=value** | Key-value pair, sets Cookie name and corresponding value, both must be **string type** - If value is Unicode characters, needs character encoding. - If value is binary data, needs BASE64 encoding. |
|   **domain**   | Specifies cookie's domain, defaults to current domain                         |
|    **path**    | **Specifies which path (route) cookie is effective on, defaults to '/'**. If set to `/abc`, only routes under `/abc` can access this cookie, like `/abc/read`. |
|   **maxAge**   | Cookie expiration time in seconds. If positive integer, cookie expires after maxAge seconds. If negative, cookie is temporary and expires when browser closes, not saved in any form. If 0, deletes this cookie. Defaults to -1. - **Better than expires**. |
|  **expires**   | Expiration time, cookie becomes invalid after set time point. Generally browser cookies are stored by default, deleted when browser closes ending the session |
|   **secure**   | Whether cookie is only transmitted via secure protocols. Secure protocols include HTTPS, SSL etc., encrypting data before network transmission. Defaults to false. When secure is true, cookie is invalid in HTTP, only valid in HTTPS. |
|  **httpOnly**  | **If a cookie is set with httpOnly attribute, its information cannot be read via JS scripts, but can still be manually modified in Application, so it only provides some degree of XSS attack prevention, not absolute security** |

Cookie's purpose is clear - for **state storage**, but it has several fatal flaws:

1. Capacity limitation. Cookie's size limit is only `4KB`, can only store small amounts of information.
2. Performance issues. Cookie follows domain, regardless of whether a specific address under the domain needs this Cookie, requests will carry complete Cookie, causing significant performance waste as request numbers increase due to carrying unnecessary content.
3. Security issues. Since Cookie is transmitted in plain text between browser and server, it can easily be intercepted by unauthorized users, modified, and resent to server during Cookie's validity period, which is quite dangerous. Additionally, when `HttpOnly` is false, Cookie information can be directly read through JS script `document.cookie`.

In browser's `same-origin policy`, `same-origin` refers to same `protocol`, `domain`, and `port`, while Cookie's `same-origin` only requires same `domain`, meaning two URLs can share cookies as long as their domains are same, note this doesn't require same `protocol` and `port`.
So `https://example.com:8080/` and `http://example.com:8081/` share cookies because their `domain` is both `example.com`.

Same-origin policy considers `domain` and `subdomain` as different domains, for example `child1.a.com` and `a.com`, `child1.a.com` and `child2.a.com`, `xxx.child1.a.com` and `child1.a.com` are all `different origins`.

Cookie issues between parent and child domains (horizontal is cookie's domain value, vertical is current address bar URL, table content indicates whether access is possible)

| Domain/cookie.domain | molibird.com | .molibird.com | a.molibird.com | b.molibird.com |
| :--------------- | :----------: | :-----------: | :------------: | :------------: |
| molibird.com     |     Yes     |     Yes      |       X        |       X        |
| a.molibird.com   |      X       |     Yes      |      Yes      |       X        |
| b.molibird.com   |      X       |     Yes      |       X        |      Yes      |

**Correction: Above table content isn't entirely correct. In old specification RFC2109, .oa.com and oa.com are different, cookies with domain oa.com can't be accessed by subdomain a.oa.com, while .oa.com can; in new specification RFC6265, .oa.com and oa.com are same, both can be accessed by subdomains.**

**Session cookies:**

**If a cookie doesn't contain expiration date, it's considered a session cookie. Session cookies are stored in memory, never written to disk. When browser closes, cookies are permanently lost.**

Reference articles:

[How much do you know about cookies?](https://juejin.im/post/6847902220227182606)

## localStorage

### Similarities and Differences with Cookie

`localStorage` has one thing in common with `Cookie`: both are bound to a single domain.

However, it has many differences from `Cookie`:

1. Capacity. localStorage's capacity limit is **5M**, much larger than Cookie's 4K. This 5M is per domain, providing persistent storage for a domain.
2. Only exists on client side, by default doesn't participate in server communication. This well avoids Cookie's **performance issues** and **security issues**.
3. Interface encapsulation. Exposed globally through `localStorage`, operated through its methods like `setItem` and `getItem`, very convenient.

### Operation Methods

Let's look at how to operate `localStorage`.

```js
let obj = { name: "sanyuan", age: 18 };
localStorage.setItem("name", "sanyuan"); 
localStorage.setItem("info", JSON.stringify(obj));
```

Then when entering same domain, can get corresponding values:

```js
let name = localStorage.getItem("name");
let info = JSON.parse(localStorage.getItem("info"));
```

From this we can see that `localStorage` actually stores everything as strings, if storing objects need to call `JSON`'s `stringify` method, and use `JSON.parse` to parse back into objects.

```js
// Clear single item
localStorage.remove('name')
// Clear all
localStorage.clear()
```

### Setting Expiration Time

localStorage itself doesn't have expiration time, but there's a solution

Overwrite its setItem and getItem, set a timestamp, when getItem finds it's expired, remove it

### Application Scenarios

Utilizing localStorage's larger capacity and persistence, can use localStorage to store stable resources like official website `logo`, store `Base64` format image resources, after setting in frontend, can avoid requesting from server again.

## sessionStorage

### Characteristics

`sessionStorage` is consistent with `localStorage` in following aspects:

- Capacity. Upper limit also 5M.
- Only exists on client side, by default doesn't participate in server communication.
- Interface encapsulation. Except for name change to `sessionStorage`, storage method and operation method same as `localStorage`.

But `sessionStorage` has one fundamental difference from `localStorage`: former is only session-level storage, not persistent storage. When session ends, meaning Tab closes, this part of `sessionStorage` no longer exists.

**Different pages of same browser with same domain and port can share same `localStorage`, but different pages cannot share `sessionStorage` information.**

### Application Scenarios

1. Can use it to maintain form information, storing form information in it ensures form information won't be lost even if page refreshes.
2. Can use it to store current browsing records. If these records aren't needed after closing page, sessionStorage is perfect.

## indexDB

`IndexDB` is a `NoSQL database` running in browser, essentially a database, definitely not on same level as `WebStorage`'s 5M, theoretically this capacity has no upper limit.

## Supplementary

### Differences between cookie and session

* Session authentication flow:

1. When user first requests server, server creates corresponding Session based on user's submitted information

2. When returning request, returns this Session's unique identifier SessionID to browser

3. After browser receives SessionID information returned by server, stores this information in Cookie, meanwhile Cookie records which domain this SessionID belongs to

4. When user accesses server second time, request automatically checks if Cookie information exists under this domain, if exists automatically sends Cookie information to server side, server gets SessionID from Cookie, then finds corresponding Session information based on SessionID, if not found means user hasn't logged in or login expired, if Session found proves user has logged in can execute following operations.

* Differences

1. Session on server side, cookie on client side (browser)
2. Session can be stored in server's files, database, or memory, in Node.js defaults to memory
3. Cookie can be set to maintain for long time, like commonly used default login function, Session generally has shorter expiration time, expires when client closes (by default) or Session times out
4. Session operation depends on session id, session id sent from server to client, session id generally stored in cookie, meaning if browser disables cookie, session also becomes invalid (but can be implemented through other ways, like passing session_id in url)
5. User verification scenarios generally use session
6. Single Cookie can't store data over 4K, Session can store far more data than Cookie, but when access volume is high, will occupy too much server resource

Reference articles:

[What's the difference between COOKIE and SESSION?](https://www.zhihu.com/question/19786827)

[Cookie and Session Relationship and Differences](https://juejin.im/post/6844903575684907016)

### About session expiration time

**Misunderstanding about Session mechanism:** Session disappears as soon as browser closes

This statement is incorrect, reason for this statement is: most session mechanisms use **session cookies** to save session id, and this session id disappears after closing browser, when connecting to server again can't find original session

Server can also set expiration time when saving Session, server's Web service container usually also has default expiration time. If server-set cookie is saved to hard disk, or some means is used to rewrite HTTP request header sent by browser, sending original session id to server, can still find original session when reopening browser. **However, when time between closing browser and client's last use of session exceeds set expiration time, server can consider client has stopped activity, will delete session to save storage space.**

### token, JWT

Token verification flow:

1. Client requests login with username and password
2. Server receives request, verifies username and password
3. After successful verification, server issues a Token, then sends this Token to client
4. After client receives Token can store it, like in LocalStorage
5. Client needs to carry server-issued Token when requesting resources from server each time
6. Server receives request, then verifies Token carried in client request, if verification successful, returns requested data to client

**Each request needs to carry token, need to put token in HTTP Header.**

**Token-based user authentication is a stateless authentication method on server side, server doesn't need to store token data. Exchanges session storage space for token parsing computation time, thus reducing server pressure, reducing frequent database queries.**

**Token is completely managed by application, so it can bypass same-origin policy.**

JWT represents: JSON Web Tokens. Can also be called JSON Web token.

- JWT authentication flow:

  - User inputs username/password to login, after server authentication succeeds, returns JWT to client
  - Client saves token locally (usually using localstorage, can also use cookie)
  - When user wants to access protected route or resource, needs to add JWT using Bearer mode in Authorization field of request header, content looks like this

  ```http
  Authorization: Bearer <token>
  ```

  - Server's protected route will check JWT information in request header Authorization, if legal, allows user's action
  - Because JWT is self-contained (contains some session information internally), thus reduces need to query database

<img src="http://img.stark.pub/20201011122944.png" style="zoom: 67%;" />

Used in project! Also recorded usage in project review.

JSON Web Tokens consists of three parts separated by dots (.), they are:

1. Header
2. Payload
3. Signature

Therefore, JWT typically displays as:

xxxxx.yyyyy.zzzz

* Header

Header is a JSON object

```js
{
  "alg": "HS256", // indicates signing algorithm, defaults to HMAC SHA256 (written as HS256)
  "typ": "JWT"  // indicates Token type, JWT token uniformly written as JWT
}
```

* Payload

Payload part is also JSON object, used to store actual data needing transmission

```js
{
  // 7 official fields
  "iss": "a.com", // issuer
  "exp": "1d", // expiration time
  "sub": "test", // subject
  "aud": "xxx", // audience
  "nbf": "xxx", // Not Before
  "iat": "xxx", // Issued At
  "jti": "1111", // JWT ID
  // can define private fields
  "name": "John Doe",
  "admin": true
}
```

JWT defaults to unencrypted, anyone can read it, so don't put secret information in this part.

JWT's `exp` claim is optional. If token doesn't have it, considered not to expire.

* Signature

Signature is signature of first two parts, prevents data tampering. Needs to specify a secret key, encrypted with algorithm in Header.

Reference articles:

[Token-based Authentication: JSON Web Token (with Node.js Project Example)](https://www.jianshu.com/p/3182fa6a52a4)

[Can't Tell Apart: Cookie, Session, Token, JWT](https://juejin.im/post/6844904034181070861)