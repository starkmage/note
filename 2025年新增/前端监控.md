# å‰ç«¯æ€§èƒ½æŒ‡æ ‡è®¡ç®—æ–¹æ³•ä¸Ž PerformanceObserver é¢è¯•è¯¦è§£

## ä¸€ã€å‰ç«¯æ€§èƒ½æŒ‡æ ‡æ ¸å¿ƒæ¦‚å¿µ

å‰ç«¯æ€§èƒ½æŒ‡æ ‡ç”¨æ¥è¡¡é‡é¡µé¢åŠ è½½å’Œæ¸²æŸ“çš„ç”¨æˆ·ä½“éªŒï¼Œå¸¸ç”¨æŒ‡æ ‡åŒ…æ‹¬ï¼š

- **FPï¼ˆFirst Paintï¼‰**ï¼šæµè§ˆå™¨é¦–æ¬¡ç»˜åˆ¶ä»»ä½•å†…å®¹çš„æ—¶é—´ç‚¹ã€‚
- **FCPï¼ˆFirst Contentful Paintï¼‰**ï¼šé¦–æ¬¡ç»˜åˆ¶ä»»ä½•æ–‡æœ¬ã€å›¾ç‰‡ã€SVGç­‰å†…å®¹çš„æ—¶é—´ç‚¹ã€‚
- **LCPï¼ˆLargest Contentful Paintï¼‰**ï¼šé¦–æ¬¡åŠ è½½é¡µé¢ä¸Šæœ€å¤§å¯è§å†…å®¹å…ƒç´ çš„æ—¶é—´ç‚¹ã€‚
- **FIDï¼ˆFirst Input Delayï¼‰**ï¼šç”¨æˆ·é¦–æ¬¡äº¤äº’ï¼ˆç‚¹å‡»ã€è¾“å…¥ï¼‰åˆ°æµè§ˆå™¨å“åº”çš„å»¶è¿Ÿæ—¶é—´ã€‚
- **CLSï¼ˆCumulative Layout Shiftï¼‰**ï¼šé¡µé¢å¸ƒå±€è§†è§‰ç¨³å®šæ€§æŒ‡æ ‡ï¼Œè¡¡é‡é¡µé¢å…ƒç´ æ„å¤–ç§»åŠ¨çš„ç´¯è®¡åˆ†æ•°ã€‚
- **TTFBï¼ˆTime to First Byteï¼‰**ï¼šä»Žè¯·æ±‚å‘å‡ºåˆ°æ”¶åˆ°ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æ—¶é—´ã€‚
- **DCLï¼ˆDOMContentLoadedï¼‰**ï¼šDOMè§£æžå®Œæˆäº‹ä»¶ã€‚
- **Load Event**ï¼šé¡µé¢æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆäº‹ä»¶ã€‚

è¿™äº›æŒ‡æ ‡ç»„åˆèµ·æ¥èƒ½å…¨é¢åæ˜ é¡µé¢ä»Žå¼€å§‹åŠ è½½åˆ°ç”¨æˆ·å¯äº¤äº’çš„ä½“éªŒã€‚

------

## äºŒã€Performance API ä¸Ž PerformanceObserver

### 1. Performance API

- æä¾›äº†æµè§ˆå™¨å†…éƒ¨è¯¦ç»†çš„æ—¶é—´ç‚¹æ•°æ®ï¼Œä¸»è¦é€šè¿‡`performance.getEntries()`èŽ·å–ã€‚

- æ”¯æŒå¤šç§ç±»åž‹çš„æ€§èƒ½æ¡ç›®ï¼ˆPerformanceEntryï¼‰ï¼Œå¦‚ `navigation`, `resource`, `paint`, `mark`, `measure` ç­‰ã€‚

- âœ…å…¸åž‹å¯¼èˆªæ—¶é—´çº¿

  ```js
  const [nav] = performance.getEntriesByType('navigation');
  
  console.log(nav.startTime);          // 0
  console.log(nav.fetchStart);         // 20.45
  console.log(nav.requestStart);       // 40.89,â±ï¸ æµè§ˆå™¨å‡†å¤‡å‘èµ·ä¸»æ–‡æ¡£è¯·æ±‚çš„æ—¶é—´ï¼ˆå³ HTTP è¯·æ±‚å¼€å§‹å‘é€ï¼‰
  console.log(nav.responseStart);      // 120.12
  console.log(nav.responseEnd);        // 180.77
  console.log(nav.domContentLoadedEventEnd); // 240.00
  console.log(nav.loadEventEnd);       // 350.22
  ```

  - æ‰€æœ‰è¿™äº›æ—¶é—´å€¼éƒ½æ˜¯ç›¸å¯¹äºŽ `navigation.startTime = 0`ã€‚
  - å¦‚æžœä½ æƒ³å¾—åˆ°â€œ**ä»Žé¡µé¢å¯¼èˆªå¼€å§‹åˆ°æŸäº‹ä»¶çš„è€—æ—¶**â€ï¼Œç›´æŽ¥ä½¿ç”¨è¿™äº›å­—æ®µçš„å€¼å³å¯ã€‚
  - `performance.now()` è¿”å›žçš„æ˜¯**ä»Žé¡µé¢ï¼ˆNavigationStartï¼‰åŠ è½½å¼€å§‹**åˆ°å½“å‰çš„ **é«˜ç²¾åº¦æ—¶é—´æˆ³ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰**ã€‚å³ä½¿ä½ è§¦å‘äº† React çš„é‡æ¸²æŸ“ã€DOM æ›´æ–°ã€ç”šè‡³é‡æ–°æ‰§è¡Œç»„ä»¶å‡½æ•°ï¼Œ**å®ƒçš„æ—¶é—´æ˜¯é€’å¢žçš„ï¼Œä¸ä¼šè¢«é‡ç½®**

### 2. PerformanceObserver

- æ˜¯ç›‘å¬æ€§èƒ½æŒ‡æ ‡å˜åŒ–çš„æŽ¥å£ï¼Œå¯ä»¥å®žæ—¶ç›‘å¬æ–°å¢žçš„æ€§èƒ½æ¡ç›®ã€‚
- å…¸åž‹ç”¨æ³•ï¼š

```js
const observer = new PerformanceObserver((list) => {
  const entries = list.getEntries();
  entries.forEach(entry => {
    console.log(entry);
    // è¿™é‡Œå¯ä»¥å¯¹æ€§èƒ½æ¡ç›®è¿›è¡Œç»Ÿè®¡æˆ–ä¸ŠæŠ¥
  });
});
observer.observe({ type: 'paint', buffered: true });
```

- `buffered: true` è¡¨ç¤ºç›‘å¬ä»Žé¡µé¢åŠ è½½å¼€å§‹å·²ç»äº§ç”Ÿçš„æ€§èƒ½æ¡ç›®ã€‚

åœ¨ç›‘å¬æ€§èƒ½æŒ‡æ ‡æ—¶ï¼Œåƒ FCPã€LCP è¿™ç§å¯èƒ½åœ¨ JS åˆå§‹åŒ–å‰å°±å·²ç»å‘ç”Ÿäº†ã€‚ä¸ºäº†ç¡®ä¿èƒ½æ‹¿åˆ°å®Œæ•´çš„æ€§èƒ½æ•°æ®ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä¸º PerformanceObserver æ·»åŠ  `buffered: true` é€‰é¡¹ï¼Œè¿™æ ·å°±å¯ä»¥åŒæ—¶èŽ·å–ç›‘å¬ä¹‹å‰å·²ç»å‘ç”Ÿçš„æ€§èƒ½æ¡ç›®ï¼Œé¿å…å…³é”®æŒ‡æ ‡ç¼ºå¤±ã€‚

------

## ä¸‰ã€å¸¸è§æ€§èƒ½æŒ‡æ ‡çš„è®¡ç®—æ–¹æ³•

### 1. FP å’Œ FCP

- **æ¥æº**ï¼šPerformance API ä¸­çš„ `paint` ç±»åž‹ã€‚
- **èŽ·å–æ–¹æ³•**ï¼š

```js
const observer = new PerformanceObserver((list) => {
  list.getEntries().forEach(entry => {
    if (entry.name === 'first-paint') {
      console.log('FP:', entry.startTime);
    }
    if (entry.name === 'first-contentful-paint') {
      console.log('FCP:', entry.startTime);
    }
  });
});
observer.observe({ type: 'paint', buffered: true });
```

- `startTime` æ˜¯ä»Žé¡µé¢å¯¼èˆªå¼€å§‹åˆ°è¯¥äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ï¼ˆå•ä½ msï¼‰ã€‚

- PerformanceObserver ä¸­çš„ `entry.startTime`ã€`renderTime`ã€`loadTime` éƒ½æ˜¯ä»¥ `performance.timeOrigin` ä¸ºèµ·ç‚¹çš„é«˜ç²¾åº¦æ—¶é—´æˆ³ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œç­‰ä»·äºŽè°ƒç”¨ `performance.now()` äº§ç”Ÿçš„æ—¶é—´æ ¼å¼ï¼Œå¯ç›´æŽ¥ç”¨äºŽå‰ç«¯æ€§èƒ½è®¡ç®—å’Œæ—¶é—´é—´éš”åˆ¤æ–­ã€‚

- ðŸ§  ç®€å•ç†è§£`performance.now()` ï¼š

  ```js
  performance.now(); // => 1234.567890123 æ¯«ç§’
  ```

  è¿™è¡¨ç¤ºâ€œä»Žé¡µé¢å¼€å§‹åŠ è½½ï¼ˆnavigation startï¼‰åˆ°çŽ°åœ¨â€å¤§çº¦è¿‡äº† 1234.57msã€‚

------

### 2. LCPï¼ˆLargest Contentful Paintï¼‰

- **å®šä¹‰**ï¼šé¡µé¢æœ€å¤§å¯è§å…ƒç´ é¦–æ¬¡æ¸²æŸ“çš„æ—¶é—´ç‚¹ï¼Œç›´æŽ¥å…³è”ç”¨æˆ·æ„ŸçŸ¥é¡µé¢åŠ è½½å®Œæˆã€‚
- **è®¡ç®—æ–¹æ³•**ï¼š

```js
const observer = new PerformanceObserver((list) => {
  const entries = list.getEntries();
  entries.forEach(entry => {
    // entry.renderTime or entry.loadTime è®°å½•æœ€å¤§å†…å®¹ç»˜åˆ¶æ—¶é—´
    console.log('LCP:', entry.startTime);
  });
});
observer.observe({ type: 'largest-contentful-paint', buffered: true });
```

- > æµè§ˆå™¨åœ¨é¡µé¢åŠ è½½è¿‡ç¨‹ä¸­**ä¼šä¸æ–­å°è¯•æ›´æ–°å½“å‰â€œæœ€å¤§çš„å†…å®¹ç»˜åˆ¶é¡¹â€**ï¼Œæ‰€ä»¥ PerformanceObserver ä¼šæ”¶åˆ°**å¤šä¸ª `largest-contentful-paint` æ¡ç›®**ï¼Œæ¯ä¸ªä»£è¡¨ä¸€æ¬¡æ¯”ä¸Šæ¬¡æ›´å¤§çš„å†…å®¹è¢«ç»˜åˆ¶å‡ºæ¥ã€‚æ‰€ä»¥ä½ ä¼šçœ‹åˆ°ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢æ˜¯å¤šä¸ª LCP å°è¯•å€¼ï¼Œæœ€ç»ˆä¸€ä¸ªè¢«ç¡®å®šä¸ºâ€œæœ€ç»ˆ LCPâ€ã€‚

- **LCP è®¡ç®—ä¸ä¼šå› é¡µé¢åŠ è½½å®Œæˆäº‹ä»¶è€Œç»ˆæ­¢**ï¼ŒLargest Contentful Paint çš„è®¡ç®—ä¼šåœ¨ä»¥ä¸‹æœ€æ—©å‘ç”Ÿçš„æ—¶åˆ»è¢«æœ€ç»ˆç¡®å®šï¼š

  - **ç”¨æˆ·ç¬¬ä¸€æ¬¡ç‚¹å‡»é¼ æ ‡æˆ–è§¦æ‘¸å±å¹•ã€‚**
  - **ç”¨æˆ·ç¬¬ä¸€æ¬¡æŒ‰ä¸‹é”®ç›˜ä¸Šçš„æŒ‰é”®ã€‚**
  - **ç”¨æˆ·ç¬¬ä¸€æ¬¡æ»šåŠ¨é¡µé¢ã€‚**
  - **ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µæˆ–æœ€å°åŒ–æµè§ˆå™¨çª—å£ã€‚**

------

### 3. FIDï¼ˆFirst Input Delayï¼‰

- **å®šä¹‰**ï¼šç”¨æˆ·é¦–æ¬¡äº¤äº’äº‹ä»¶è§¦å‘åˆ°æµè§ˆå™¨å®žé™…å“åº”çš„æ—¶é—´å·®ã€‚
- **èŽ·å–æ–¹æ³•**ï¼š

```js
const observer = new PerformanceObserver((list) => {
  list.getEntries().forEach(entry => {
    console.log('FID:', entry.processingStart - entry.startTime);
  });
});
observer.observe({ type: 'first-input', buffered: true });
```

- è®¡ç®—å»¶è¿Ÿ = `processingStart` - `startTime`ã€‚

------

### 4. CLSï¼ˆCumulative Layout Shiftï¼‰

- **å®šä¹‰**ï¼šè¡¡é‡é¡µé¢å†…å®¹å¸ƒå±€æ„å¤–å˜åŒ–çš„ç´¯ç§¯åˆ†æ•°ï¼Œè¶Šå°è¶Šå¥½ã€‚
- **èŽ·å–æ–¹æ³•**ï¼š

```js
let clsValue = 0;
const observer = new PerformanceObserver((list) => {
  list.getEntries().forEach(entry => {
    if (!entry.hadRecentInput) {
      clsValue += entry.value;
      console.log('CLSå¢žé‡:', entry.value, 'ç´¯è®¡CLS:', clsValue);
    }
  });
});
observer.observe({ type: 'layout-shift', buffered: true });
```

- 

------

### 5. é¡µé¢åŠ è½½æ—¶é—´ã€TTFBã€DCLã€Load Event

- å¯ä»¥ä»Ž `performance.timing` æˆ–æ›´çŽ°ä»£çš„ `performance.getEntriesByType('navigation')` èŽ·å–ã€‚

```js
const [navigation] = performance.getEntriesByType('navigation');

console.log('TTFB:', navigation.responseStart - navigation.requestStart);
console.log('DOMè§£æžå®Œæˆæ—¶é—´:', navigation.domContentLoadedEventEnd);
console.log('é¡µé¢åŠ è½½å®Œæˆæ—¶é—´:', navigation.loadEventEnd);
```

---

## å››ã€é¢è¯•ç­”é¢˜è¦ç‚¹

- **ç†è§£æŒ‡æ ‡å«ä¹‰**ï¼Œå¹¶èƒ½è¯´å‡ºå…¸åž‹çš„è¡¡é‡æ ‡å‡†ã€‚
- **ç†Ÿæ‚‰Performance API**ï¼Œèƒ½ç”¨`performance.getEntries()`å’Œ`PerformanceObserver`ç›‘å¬å…³é”®æŒ‡æ ‡ã€‚
- **å…³é”®æŒ‡æ ‡è®¡ç®—ç»†èŠ‚**ï¼š
  - FP/FCPå…³æ³¨`paint`æ¡ç›®ã€‚
  - LCPç›‘å¬`largest-contentful-paint`æ¡ç›®ï¼Œéœ€å–æœ€åŽä¸€æ¬¡è®°å½•ã€‚
  - FIDç›‘å¬`first-input`æ¡ç›®ï¼Œè®¡ç®—å»¶è¿Ÿå·®ã€‚
  - CLSç›‘å¬`layout-shift`æ¡ç›®ï¼Œç´¯è®¡æ— äº¤äº’æ—¶çš„å¸ƒå±€åç§»ã€‚
- **æ€§èƒ½æŒ‡æ ‡çš„å®žé™…åº”ç”¨**ï¼š
  - ç”¨äºŽæ€§èƒ½ç›‘æŽ§åŸ‹ç‚¹ï¼Œä¸ŠæŠ¥ç”¨æˆ·çœŸå®žä½“éªŒã€‚
  - ç»“åˆä¸šåŠ¡åœºæ™¯è°ƒæ•´é¡µé¢ä¼˜åŒ–ç­–ç•¥ï¼ˆå¦‚å»¶è¿ŸåŠ è½½ã€èµ„æºä¼˜åŒ–ï¼‰ã€‚
- **çŽ°ä»£æµè§ˆå™¨æ”¯æŒæƒ…å†µ**ï¼š
  - PerformanceObserverè¾ƒæ–°ï¼Œä¸»æµæµè§ˆå™¨æ”¯æŒè‰¯å¥½ã€‚
  - éƒ¨åˆ†æŒ‡æ ‡ï¼ˆFIDï¼‰éœ€è¦ç”¨æˆ·äº¤äº’è§¦å‘ã€‚
- **å…¶ä»–è¡¥å……**ï¼š
  - å¯ç»“åˆLighthouseã€Web Vitalså·¥å…·è¿›è¡Œè¡¥å……æµ‹è¯•ã€‚
  - å¯ç”¨`buffered: true`ç›‘å¬åŽ†å²æ¡ç›®ï¼Œé˜²æ­¢é—æ¼ã€‚

------

## äº”ã€ç¤ºä¾‹ä»£ç æ¨¡æ¿ï¼ˆé¢è¯•æ¼”ç¤ºç”¨ï¼‰

```js
// ç›‘å¬FP/FCP
const paintObserver = new PerformanceObserver((list) => {
  list.getEntries().forEach(entry => {
    if (entry.name === 'first-paint') {
      console.log('FP:', entry.startTime.toFixed(2));
    }
    if (entry.name === 'first-contentful-paint') {
      console.log('FCP:', entry.startTime.toFixed(2));
    }
  });
});
paintObserver.observe({ type: 'paint', buffered: true });

// ç›‘å¬LCP
let lcpTime = 0;
const lcpObserver = new PerformanceObserver((list) => {
  const entries = list.getEntries();
  const lastEntry = entries[entries.length - 1];
  lcpTime = lastEntry.startTime;
  console.log('LCP:', lcpTime.toFixed(2));
});
lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true });

// ç›‘å¬FID
const fidObserver = new PerformanceObserver((list) => {
  list.getEntries().forEach(entry => {
    const fid = entry.processingStart - entry.startTime;
    console.log('FID:', fid.toFixed(2));
  });
});
fidObserver.observe({ type: 'first-input', buffered: true });

// ç›‘å¬CLS
let clsValue = 0;
const clsObserver = new PerformanceObserver((list) => {
  list.getEntries().forEach(entry => {
    if (!entry.hadRecentInput) {
      clsValue += entry.value;
      console.log('CLS:', clsValue.toFixed(4));
    }
  });
});
clsObserver.observe({ type: 'layout-shift', buffered: true });
```

å¥½çš„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€æ´æ˜Žäº†ã€é€‚åˆé¢è¯•ç”¨çš„ **Datadog RUM ç›‘æŽ§å‰ç«¯æ€§èƒ½çš„å·¥ä½œåŽŸç†ä»‹ç»** æ¨¡æ¿ï¼š

------

# Datadog RUM ç›‘æŽ§å‰ç«¯æ€§èƒ½å·¥ä½œåŽŸç†

Datadog RUMï¼ˆçœŸå®žç”¨æˆ·ç›‘æŽ§ï¼‰é€šè¿‡æµè§ˆå™¨å†…ç½®çš„æ€§èƒ½APIåŠäº‹ä»¶ç›‘å¬ï¼Œå®žæ—¶é‡‡é›†ç”¨æˆ·å®žé™…è®¿é—®é¡µé¢æ—¶çš„æ€§èƒ½æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **åŸºäºŽæµè§ˆå™¨ Performance API é‡‡é›†å…³é”®æ€§èƒ½æŒ‡æ ‡**
    åˆ©ç”¨ `performance.getEntries()` å’Œ `performance.getEntriesByType()` èŽ·å–é¡µé¢å¯¼èˆªæ—¶é—´ã€èµ„æºåŠ è½½æ—¶é—´ã€é¦–å­—èŠ‚æ—¶é—´ï¼ˆTTFBï¼‰ã€DOM è§£æžå®Œæˆç­‰åŸºç¡€æ€§èƒ½æ•°æ®ã€‚
2. **é€šè¿‡ PerformanceObserver å®žæ—¶ç›‘å¬å…³é”®æ€§èƒ½äº‹ä»¶**
   - **FPï¼ˆFirst Paintï¼‰å’Œ FCPï¼ˆFirst Contentful Paintï¼‰** ç›‘å¬ `paint` ç±»åž‹æ€§èƒ½æ¡ç›®ã€‚
   - **LCPï¼ˆLargest Contentful Paintï¼‰** ç›‘å¬é¡µé¢æœ€å¤§å¯è§å†…å®¹çš„ç»˜åˆ¶æ—¶é—´ã€‚
   - **FIDï¼ˆFirst Input Delayï¼‰** ç›‘å¬ç”¨æˆ·é¦–æ¬¡äº¤äº’äº‹ä»¶åˆ°æµè§ˆå™¨å“åº”çš„å»¶è¿Ÿã€‚
   - **CLSï¼ˆCumulative Layout Shiftï¼‰** ç›‘å¬é¡µé¢å¸ƒå±€åç§»äº‹ä»¶ï¼Œè¡¡é‡è§†è§‰ç¨³å®šæ€§ã€‚
3. **ç»“åˆç”¨æˆ·äº¤äº’äº‹ä»¶å’Œè‡ªå®šä¹‰åŸ‹ç‚¹**
    ç›‘å¬ç”¨æˆ·æ“ä½œäº‹ä»¶ï¼Œç»“åˆæµè§ˆå™¨æ€§èƒ½æ•°æ®ï¼Œè®¡ç®—äº¤äº’ä½“éªŒæŒ‡æ ‡ï¼Œè¿›ä¸€æ­¥è¡¥å……æ€§èƒ½æ•°æ®çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚
4. **æ•°æ®å¤„ç†ä¸Žä¸ŠæŠ¥**
    Datadog RUM SDKå¯¹é‡‡é›†åˆ°çš„æ€§èƒ½æŒ‡æ ‡åšå®žæ—¶èšåˆã€è¿‡æ»¤å’ŒåŽ»é‡ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®ã€‚ç„¶åŽå°†æ€§èƒ½æ•°æ®å®žæ—¶å‘é€åˆ°DatadogåŽç«¯ï¼Œæ”¯æŒå¤§è§„æ¨¡æ€§èƒ½åˆ†æžã€å¯è§†åŒ–å’ŒæŠ¥è­¦ã€‚
5. **ä¼˜åŠ¿**
   - æ— éœ€æœåŠ¡å™¨ç«¯æ”¹åŠ¨ï¼Œç›´æŽ¥åœ¨å‰ç«¯é‡‡é›†çœŸå®žç”¨æˆ·çš„ä½“éªŒæ•°æ®ã€‚
   - åˆ©ç”¨çŽ°ä»£æµè§ˆå™¨æ€§èƒ½APIæ ‡å‡†ï¼Œæ•°æ®å‡†ç¡®ä¸”è¦†ç›–å…³é”®ç”¨æˆ·ä½“éªŒæŒ‡æ ‡ã€‚
   - æ”¯æŒå¤šç§æµè§ˆå™¨å’Œè®¾å¤‡ï¼Œé€‚ç”¨èŒƒå›´å¹¿æ³›ã€‚

------

**æ€»ç»“**ï¼šDatadog RUM åŸºäºŽæµè§ˆå™¨çš„ Performance API å’Œ PerformanceObserver æŠ€æœ¯ï¼Œç»“åˆç”¨æˆ·äº¤äº’ç›‘å¬ï¼Œå®žçŽ°å¯¹å‰ç«¯å…³é”®æ€§èƒ½æŒ‡æ ‡çš„å®žæ—¶é‡‡é›†å’Œä¸ŠæŠ¥ï¼Œå¸®åŠ©å›¢é˜Ÿå…¨é¢æŽŒæ¡çœŸå®žç”¨æˆ·çš„é¡µé¢æ€§èƒ½è¡¨çŽ°ã€‚

å¥½çš„ï¼åœ¨ SSRï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ï¼‰åœºæ™¯ä¸‹å›žç­”â€œå‰ç«¯æ€§èƒ½æŒ‡æ ‡è®¡ç®—æ–¹æ³•ä¸Ž PerformanceObserverâ€çš„é¢è¯•é¢˜æ—¶ï¼Œéœ€è¦ç»“åˆ SSR ç‰¹ç‚¹ï¼Œçªå‡ºæŒ‡æ ‡é‡‡é›†çš„éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆã€‚ä¸‹é¢æ˜¯ä¸€ä»½é€‚åˆé¢è¯•çš„è¯¦ç»†å›žç­”ç»“æž„å’Œè¦ç‚¹ï¼š

------

# Datadog RUM æä¾›çš„ä¸»è¦æŒ‡æ ‡ç±»åž‹

Datadog RUM èƒ½å¸®åŠ©å‰ç«¯å›¢é˜Ÿä»Ž**é¡µé¢åŠ è½½æ€§èƒ½ã€é™æ€èµ„æºã€æŽ¥å£è°ƒç”¨ã€ç”¨æˆ·è¡Œä¸º**ç­‰å¤šä¸ªç»´åº¦ï¼Œå®žæ—¶é‡‡é›†å’Œåˆ†æžçœŸå®žç”¨æˆ·çš„ä½“éªŒæ•°æ®ï¼Œå¹¶æ”¯æŒç²¾ç»†åŒ–ç»´åº¦æ‹†åˆ†å’Œå‰åŽç«¯ Trace è”åŠ¨ï¼Œæ˜¯æˆ‘ä»¬å‰ç«¯æ€§èƒ½ä¼˜åŒ–å’Œå¯è§‚æµ‹æ€§å»ºè®¾çš„é‡è¦å·¥å…·ã€‚

## ðŸŸ¢ 1. æ ¸å¿ƒ Web Vitalsï¼ˆç”¨æˆ·ä½“éªŒè¯„åˆ†æŒ‡æ ‡ï¼‰

| æŒ‡æ ‡                        | å«ä¹‰                       | é‡è¦æ€§         |
| --------------------------- | -------------------------- | -------------- |
| **LCP**ï¼ˆæœ€å¤§å†…å®¹æ¸²æŸ“æ—¶é—´ï¼‰ | æ¸²æŸ“æœ€å¤§å¯è§†åŒºåŸŸå†…å®¹çš„æ—¶é—´ | åˆ¤æ–­é¦–å±å®Œæˆåº¦ |
| **FID**ï¼ˆé¦–æ¬¡è¾“å…¥å»¶è¿Ÿï¼‰     | ç”¨æˆ·ç¬¬ä¸€æ¬¡äº¤äº’åˆ°å“åº”çš„å»¶è¿Ÿ | åˆ¤æ–­å“åº”é€Ÿåº¦   |
| **CLS**ï¼ˆç´¯è®¡å¸ƒå±€åç§»ï¼‰     | é¡µé¢å…ƒç´ æŠ–åŠ¨ç¨‹åº¦           | åˆ¤æ–­é¡µé¢ç¨³å®šæ€§ |

ðŸ“Œ å¦‚ä½•é‡‡é›†ï¼šPerformanceObserver + `largest-contentful-paint`ã€`first-input`ã€`layout-shift`

------

## ðŸš€ 2. é¡µé¢åŠ è½½æŒ‡æ ‡ï¼ˆä»Žç½‘ç»œåˆ°é¡µé¢æ¸²æŸ“ï¼‰

| æŒ‡æ ‡                 | å«ä¹‰                        | å·¥å…·æ¥æº          |
| -------------------- | --------------------------- | ----------------- |
| **TTFB**             | é¦–å­—èŠ‚æ—¶é—´ï¼Œè¡¡é‡åŽç«¯ + ç½‘ç»œ | Navigation Timing |
| **FCP**              | é¦–æ¬¡ç»˜åˆ¶å†…å®¹ï¼ˆæ–‡å­—/å›¾åƒï¼‰   | Paint Timing      |
| **DOMContentLoaded** | DOM æž„å»ºå®Œæˆæ—¶é—´            | navigation entry  |
| **Load Time**        | æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆæ—¶é—´        | navigation entry  |

ðŸ“Œ å¯å…³è”ï¼šå…·ä½“é¡µé¢è·¯å¾„ã€æµè§ˆå™¨ç±»åž‹ã€è®¾å¤‡ç±»åž‹

------

## ðŸ§© 3. é™æ€èµ„æºåŠ è½½åˆ†æž

| èµ„æºç±»åž‹                | ç»´åº¦                                     |
| ----------------------- | ---------------------------------------- |
| JS / CSS / Image / Font | åŠ è½½è€—æ—¶ã€èµ„æºå¤§å°ã€å¤±è´¥çŽ‡ã€ç¼“å­˜å‘½ä¸­æƒ…å†µ |
| å¤–éƒ¨è„šæœ¬ï¼ˆCDNã€å¹¿å‘Šï¼‰   | æ˜¯å¦é˜»å¡žã€åŠ è½½è€—æ—¶ã€å¤±è´¥æ¬¡æ•°             |

ðŸ“Œ å·¥å…·æ¥æºï¼š`performance.getEntriesByType('resource')`

------

## ðŸ”Œ 4. æŽ¥å£è°ƒç”¨æ€§èƒ½ï¼ˆXHR / Fetchï¼‰

| æŒ‡æ ‡                | å«ä¹‰                   |
| ------------------- | ---------------------- |
| è¯·æ±‚è€—æ—¶ï¼ˆavg/p95ï¼‰ | ç½‘ç»œè€—æ—¶ã€åŽç«¯å“åº”æ—¶é•¿ |
| çŠ¶æ€ç åˆ†å¸ƒ          | 200ã€4xxã€5xx å æ¯”     |
| è¯·æ±‚æ¥æºé¡µé¢        | å“ªä¸ªé¡µé¢æˆ–æ“ä½œè§¦å‘     |
| é”™è¯¯çŽ‡              | ç½‘ç»œå¼‚å¸¸ã€è¶…æ—¶ã€æ— å“åº” |

ðŸ“Œ æ”¯æŒå…³è”æŒ‰é’®ç‚¹å‡»ã€é¡µé¢äº¤äº’ç­‰å‰å› åŽæžœåˆ†æž

------

## ðŸ‘¤ 5. ç”¨æˆ·è¡Œä¸ºä¸Žäº¤äº’è·¯å¾„

| æŒ‡æ ‡                       | å«ä¹‰                                 |
| -------------------------- | ------------------------------------ |
| ç‚¹å‡»çƒ­åŒº                   | å“ªäº›æŒ‰é’®/åŒºåŸŸç”¨æˆ·ç‚¹å‡»é¢‘ç¹            |
| é¡µé¢è·³è½¬è·¯å¾„               | ç”¨æˆ·è®¿é—®è·¯å¾„å›¾                       |
| é¡µé¢åœç•™æ—¶é—´               | æ¯ä¸ªé¡µé¢å¹³å‡é©»ç•™æ—¶é•¿                 |
| ä¼šè¯é‡æ”¾ï¼ˆSession Replayï¼‰ | å¯æŸ¥çœ‹ç”¨æˆ·å®Œæ•´è®¿é—®å½•åƒï¼Œå¤çŽ°æ€§èƒ½é—®é¢˜ |

ðŸ“Œ ç‰¹åˆ«é€‚åˆå¤ç›˜é—®é¢˜æˆ–è¿˜åŽŸå¼‚å¸¸ç”¨æˆ·è·¯å¾„

## âœ¨ Bonusï¼šå‰ç«¯å¼€å‘å…³æ³¨ç‚¹æ•´ç†

| ç±»åˆ«                 | åº”ç”¨åœºæ™¯                                 |
| -------------------- | ---------------------------------------- |
| ðŸŽ¯ **å¿«é€Ÿå‘çŽ°æ…¢é¡µé¢** | æŒ‰è·¯å¾„ç­›é€‰ LCP / Load Time é«˜çš„é¡µé¢      |
| ðŸ§± **å®šä½å¡é¡¿æ¥æº**   | ç»“åˆ Long Taskã€FIDã€æŽ¥å£å“åº”æ—¶é—´        |
| ðŸ›  **å‰åŽç«¯è”åŠ¨åˆ†æž** | å°†å‰ç«¯æ…¢ç‚¹å…³è” APM traceï¼ŒæŸ¥çœ‹æ˜¯å¦åŽç«¯æ…¢ |
| ðŸš¨ **è®¾ç½®æŠ¥è­¦é˜ˆå€¼**   | æ¯”å¦‚ LCP > 4sã€æŽ¥å£é”™è¯¯çŽ‡ > 5% å³å‘Šè­¦    |
| ðŸ“‰ **ç‰ˆæœ¬å¯¹æ¯”**       | ä¸Šçº¿å‰åŽ LCP/FID å¯¹æ¯”ï¼Œè¯„ä¼°ä¼˜åŒ–æ•ˆæžœ      |

# SSR åœºæ™¯ä¸‹å‰ç«¯æ€§èƒ½æŒ‡æ ‡è®¡ç®—æ–¹æ³•ä¸Ž PerformanceObserver é¢è¯•å›žç­”ç¤ºèŒƒ

### 1. SSR ä¸Žä¼ ç»Ÿ CSR çš„æ€§èƒ½å·®å¼‚

- SSR é¡µé¢æ˜¯æœåŠ¡å™¨é¢„æ¸²æŸ“å¥½ HTML åŽè¿”å›žï¼Œæµè§ˆå™¨æ”¶åˆ°çš„æ˜¯å®Œæ•´ HTMLï¼Œé¡µé¢é¦–å±æ¸²æŸ“æ—¶é—´é€šå¸¸æ›´å¿«ã€‚
- ä½†æ˜¯é¡µé¢çš„äº¤äº’ã€åŠ¨æ€å†…å®¹å’ŒåŽç»­èµ„æºåŠ è½½ä»ç”±å®¢æˆ·ç«¯å®Œæˆã€‚
- æ€§èƒ½æŒ‡æ ‡çš„é‡‡é›†éœ€è¦åŒºåˆ†ï¼š
  - **æœåŠ¡å™¨æ¸²æŸ“æ—¶é—´ï¼ˆæœåŠ¡ç«¯æ—¶é—´ï¼‰**ï¼šè¿™éƒ¨åˆ†éœ€è¦åŽç«¯ç›‘æŽ§å’Œæ—¥å¿—ã€‚
  - **å®¢æˆ·ç«¯æ¸²æŸ“æ—¶é—´ï¼ˆå®¢æˆ·ç«¯æŒ‡æ ‡ï¼‰**ï¼šæµè§ˆå™¨å®žé™…æ‰§è¡Œ JSã€ç»˜åˆ¶å’Œäº¤äº’çš„æ€§èƒ½ã€‚

------

### 2. PerformanceObserver åœ¨ SSR åœºæ™¯çš„ä½œç”¨

- SSR é¡µé¢åŠ è½½åˆ°æµè§ˆå™¨åŽï¼Œå®¢æˆ·ç«¯ä¾ç„¶å¯ä»¥ä½¿ç”¨ PerformanceObserver ç›‘å¬å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆFPã€FCPã€LCPã€FIDã€CLS ç­‰ï¼‰ã€‚
- **è¿™äº›æŒ‡æ ‡ä»ç„¶åŸºäºŽæµè§ˆå™¨çš„ Performance API é‡‡é›†**ï¼Œä¸å›  SSR è€Œæ”¹å˜ã€‚
- ä¾‹å¦‚ï¼Œè™½ç„¶ HTML å·²ç»é¢„æ¸²æŸ“ï¼Œæµè§ˆå™¨ä»ä¼šæ‰§è¡Œ JSï¼ŒåŠ è½½èµ„æºï¼Œè§¦å‘é¦–å±ç»˜åˆ¶ç­‰æ€§èƒ½äº‹ä»¶ã€‚

------

### 3. SSRåœºæ™¯ä¸‹æ€§èƒ½æŒ‡æ ‡è®¡ç®—çš„æ³¨æ„ç‚¹

- **FP å’Œ FCP**ï¼š
  - SSR é¦–å±å†…å®¹ç”±æœåŠ¡ç«¯ç”Ÿæˆï¼ŒFP/FCP æ—¶é—´å¯èƒ½æå‰ï¼Œå› ä¸ºæµè§ˆå™¨èƒ½å¿«é€Ÿæ˜¾ç¤º HTMLã€‚ä½†ä»è¦ç›‘å¬ `paint` ç±»åž‹æŒ‡æ ‡ç¡®è®¤é¦–å±ç»˜åˆ¶æ—¶é—´ã€‚
- **LCP**ï¼š
  - LCP ä¾ç„¶æœ‰æ•ˆï¼Œåæ˜ é¡µé¢æœ€å¤§å†…å®¹å—åŠ è½½å®Œæˆæ—¶é—´ã€‚SSR é¡µé¢ä¸­ï¼Œå›¾ç‰‡å’Œå®¢æˆ·ç«¯ JS æ¸²æŸ“çš„å†…å®¹éƒ½å½±å“ LCPã€‚
- **FID å’Œ CLS**ï¼š
  - è¿™äº›æ˜¯å®¢æˆ·ç«¯äº¤äº’ç›¸å…³æŒ‡æ ‡ï¼ŒSSR ä¸å½±å“ã€‚
- **Navigation Timing** å’Œ **Resource Timing**ï¼š
  - ä¾ç„¶é€šè¿‡ `performance.getEntriesByType()` èŽ·å–ï¼ŒåŒºåˆ«æ˜¯ SSR é¡µé¢å¯èƒ½å‡å°‘æŸäº›èµ„æºè¯·æ±‚ï¼Œå½±å“ç½‘ç»œæ—¶åºã€‚

------

### 4. SSR å¯¹æŒ‡æ ‡é‡‡é›†çš„æŒ‘æˆ˜ä¸Žè§£å†³æ–¹æ¡ˆ

- **é¦–æ¬¡æ¸²æŸ“æ—¶é—´ï¼ˆTTFBï¼‰åŒ…å«æœåŠ¡å™¨å“åº”æ—¶é—´**ï¼Œè¿™éƒ¨åˆ†å±žäºŽåŽç«¯æ€§èƒ½èŒƒç•´ï¼Œéœ€ç»“åˆåŽç«¯ç›‘æŽ§å·¥å…·åˆ†æžã€‚
- **å®¢æˆ·ç«¯æ¸²æŸ“é˜¶æ®µæ€§èƒ½æŒ‡æ ‡ä»ä¾èµ–æµè§ˆå™¨ Performance API**ï¼Œå¯ä»¥é€šè¿‡ PerformanceObserver å®žæ—¶ç›‘å¬ã€‚
- **è·¯ç”±åˆ‡æ¢é—®é¢˜**ï¼š
  - SSR å¸¸é…åˆ SPA æ¡†æž¶ï¼ˆå¦‚ Next.jsï¼‰ï¼Œå®¢æˆ·ç«¯è·¯ç”±åˆ‡æ¢æ—¶ä¸å†è§¦å‘å®Œæ•´é¡µé¢åŠ è½½äº‹ä»¶ï¼Œéœ€ç»“åˆè‡ªå®šä¹‰åŸ‹ç‚¹æˆ–æ¡†æž¶æä¾›çš„ç”Ÿå‘½å‘¨æœŸé’©å­é‡æ–°è®¡ç®—æ€§èƒ½æŒ‡æ ‡ã€‚
- **æŒ‡æ ‡ä¸ŠæŠ¥æ—¶æœº**ï¼š
  - SSR é¡µé¢éœ€ç¡®ä¿ PerformanceObserver åœ¨å®¢æˆ·ç«¯ JS å¯åŠ¨æ—¶å°±æŒ‚è½½ï¼Œé¿å…é”™è¿‡å…³é”®æŒ‡æ ‡ã€‚
  - å¯¹äºŽè·¯ç”±åˆ‡æ¢ï¼Œéœ€è¦é¢å¤–è®¾è®¡æŒ‡æ ‡é‡ç½®å’Œé‡æ–°ç›‘å¬æœºåˆ¶ã€‚

------

### 5. ç®€å•ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰

```js
// SSR é¡µé¢å®¢æˆ·ç«¯ JS åˆå§‹åŒ–æ—¶æŒ‚è½½ PerformanceObserver
if (typeof window !== 'undefined' && PerformanceObserver) {
  const observer = new PerformanceObserver((list) => {
    list.getEntries().forEach(entry => {
      // å¤„ç† FP/FCP/LCP ç­‰æŒ‡æ ‡
      console.log(entry.name, entry.startTime);
    });
  });
  observer.observe({ type: 'paint', buffered: true });
  observer.observe({ type: 'largest-contentful-paint', buffered: true });
  // å…¶ä»–ç±»åž‹ç›‘å¬...
}

// SPA è·¯ç”±åˆ‡æ¢æ—¶ï¼Œé‡æ–°åˆå§‹åŒ–ç›‘å¬ï¼Œæ¸…ç†æ—§æŒ‡æ ‡
```

------

### 6. æ€»ç»“

- SSR æå‡é¦–å±æ¸²æŸ“é€Ÿåº¦ï¼Œä½†æµè§ˆå™¨ç«¯æ€§èƒ½æŒ‡æ ‡é‡‡é›†ä»åŸºäºŽ Performance API å’Œ PerformanceObserverã€‚
- éœ€åŒºåˆ†æœåŠ¡å™¨ç«¯æ€§èƒ½å’Œå®¢æˆ·ç«¯æ€§èƒ½æŒ‡æ ‡ã€‚
- SSR é…åˆ SPA éœ€è¦è®¾è®¡å¥½æ€§èƒ½æŒ‡æ ‡ç›‘å¬çš„åˆå§‹åŒ–ä¸Žé‡ç½®æœºåˆ¶ã€‚
- é¢è¯•ä¸­å¼ºè°ƒç†è§£ SSR æ€§èƒ½æŒ‡æ ‡é‡‡é›†çš„â€œå‰ç«¯èŒè´£â€å’Œâ€œåŽç«¯èŒè´£â€è¾¹ç•Œï¼Œå±•ç¤ºå…¨é¢è®¤çŸ¥ã€‚

# å‰ç«¯ç”¨æˆ·ç›‘æŽ§API

| ç±»åˆ«           | API åç§°                                          | ç”¨é€”                                     |
| -------------- | ------------------------------------------------- | ---------------------------------------- |
| ðŸ‘† ç”¨æˆ·äº¤äº’     | `addEventListener`                                | ç›‘å¬ç‚¹å‡»ã€æ»šåŠ¨ã€é”®ç›˜ç­‰äº‹ä»¶               |
| ðŸ“· é¡µé¢å¯è§æ€§   | `Page Visibility API`                             | æ£€æµ‹ç”¨æˆ·æ˜¯å¦åˆ‡æ¢äº†æ ‡ç­¾é¡µ                 |
| ðŸ§­ ä¼šè¯è¿½è¸ª     | `Performance API`                                 | è·Ÿè¸ªé¡µé¢åŠ è½½æ€§èƒ½                         |
| ðŸ–±ï¸ ç”¨æˆ·è¾“å…¥è®°å½• | `InputEvent`, `KeyboardEvent`, `MouseEvent`       | ç›‘å¬å…·ä½“è¾“å…¥ã€ç‚¹å‡»è¡Œä¸º                   |
| ðŸ‘€ å¯è§†åŒºåŸŸ     | `IntersectionObserver`                            | å…ƒç´ æ˜¯å¦è¿›å…¥è§†å£ï¼ˆå¯ç”¨äºŽæ‡’åŠ è½½/æ›å…‰ï¼‰    |
| ðŸ“ å˜åŠ¨ç›‘æŽ§     | `MutationObserver`                                | DOM æ˜¯å¦å‘ç”Ÿç»“æž„å˜åŒ–                     |
| ðŸ§± å¸ƒå±€å˜åŒ–     | `ResizeObserver`                                  | å…ƒç´ å°ºå¯¸æ˜¯å¦æ”¹å˜ï¼ˆå¦‚çª—å£ç¼©æ”¾ï¼‰           |
| ðŸŽžï¸ å½•å±         | `Screen Capture API`                              | ç”¨æˆ·æŽˆæƒåŽå¯å½•åˆ¶å±å¹•è¡Œä¸ºï¼ˆæ•æ„Ÿï¼Œéœ€æƒé™ï¼‰ |
| âŒ¨ï¸ å‰ªè´´æ¿       | `Clipboard API`                                   | ç”¨æˆ·å¤åˆ¶ã€å‰ªåˆ‡ã€ç²˜è´´æ“ä½œ                 |
| ðŸ“‹ è¡¨å•ç›‘æŽ§     | `FormData`, `submit` äº‹ä»¶                         | ç›‘æŽ§è¡¨å•å¡«å†™å’Œæäº¤è¡Œä¸º                   |
| ðŸ‘‚ é”®ç›˜é¼ æ ‡     | `pointerdown`, `keydown`, `mousemove`             | ä½Žå±‚çº§äº¤äº’è·Ÿè¸ª                           |
| ðŸ›¡ï¸ å®‰å…¨ç›‘æŽ§     | `DeviceMotion`, `DeviceOrientation`               | åˆ¤æ–­æ˜¯å¦ä¸ºæ¨¡æ‹Ÿå™¨ã€åˆ·é‡ç­‰è¡Œä¸ºï¼ˆç§»åŠ¨ç«¯ï¼‰   |
| ðŸ§  é”™è¯¯è·Ÿè¸ª     | `window.onerror`, `unhandledrejection`            | JS æŠ¥é”™ã€Promise æŠ¥é”™ç›‘æŽ§                |
| ðŸ”— ç½‘ç»œç›‘æŽ§     | `fetch`, `XMLHttpRequest`, `navigator.sendBeacon` | è¯·æ±‚è¡Œä¸ºåŸ‹ç‚¹                             |
| ðŸŽ¯ èšç„¦è¡Œä¸º     | `focus`, `blur`                                   | ç»„ä»¶/é¡µé¢æ˜¯å¦èŽ·å¾—ç„¦ç‚¹                    |
| ðŸ” è¾“å…¥è¡Œä¸º     | `beforeinput`, `input`, `change`                  | æ–‡æœ¬è¾“å…¥è¡Œä¸ºè®°å½•                         |

# å‰ç«¯ä¸ŠæŠ¥æ•°æ®çš„æ–¹å¼

**æœ€ä½³é€‰æ‹©: `navigator.sendBeacon()`**

`sendBeacon` æ˜¯ W3C ä¸“é—¨ä¸ºè§£å†³æ‰“ç‚¹ä¸ŠæŠ¥å’Œåˆ†æžæ•°æ®å‘é€è€Œè®¾è®¡çš„æ ‡å‡† APIã€‚å®ƒçš„è®¾è®¡ç›®æ ‡å°±æ˜¯**å¯é ä¸”ä¸å½±å“æ€§èƒ½**ã€‚

**å·¥ä½œåŽŸç†**: å½“ä½ è°ƒç”¨ `sendBeacon` æ—¶ï¼Œæµè§ˆå™¨ä¼šå°†è¿™ä¸ªè¯·æ±‚æ·»åŠ åˆ°ä¸€ä¸ªå‘é€é˜Ÿåˆ—ä¸­ï¼Œç„¶åŽç«‹å³è¿”å›ž `true` æˆ– `false`ï¼Œå®Œå…¨ä¸é˜»å¡žä½ å½“å‰çš„ä»£ç ã€‚æµè§ˆå™¨ä¼šåœ¨è‡ªå·±è®¤ä¸ºåˆé€‚çš„æ—¶å€™ï¼ˆé€šå¸¸æ˜¯CPUç©ºé—²æ—¶ï¼‰åœ¨åŽå°å®Œæˆè¿™æ¬¡å‘é€ï¼Œå¹¶ä¸”**å³ä¾¿é¡µé¢å·²ç»å…³é—­ï¼Œè¿™ä¸ªå‘é€ä»»åŠ¡ä¾ç„¶ä¼šç»§ç»­æ‰§è¡Œç›´è‡³å®Œæˆ**ã€‚

**ä»£ç ç¤ºä¾‹**:

```js
function reportData(data) {
  const endpoint = 'https://api.example.com/log';
  const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });

  // å¦‚æžœæµè§ˆå™¨æ”¯æŒ sendBeaconï¼Œå°±ç”¨å®ƒ
  if (navigator.sendBeacon) {
    const success = navigator.sendBeacon(endpoint, blob);
    if (success) {
      console.log('æ‰“ç‚¹ä¿¡æ¯å·²æˆåŠŸåŠ å…¥å‘é€é˜Ÿåˆ—ã€‚');
    } else {
      console.error('æ‰“ç‚¹ä¿¡æ¯åŠ å…¥å‘é€é˜Ÿåˆ—å¤±è´¥ã€‚');
    }
  } else {
    // é™çº§å¤„ç†ï¼Œæ¯”å¦‚ä½¿ç”¨ fetch
    console.warn('æµè§ˆå™¨ä¸æ”¯æŒ sendBeaconï¼Œé™çº§å¤„ç†ã€‚');
    // fetch(endpoint, ...);
  }
}

// å¸¸è§„ç‚¹å‡»äº‹ä»¶ä¸ŠæŠ¥
button.addEventListener('click', () => {
  reportData({ event: 'button_click', timestamp: Date.now() });
});

// é¡µé¢ç¦»å¼€æ—¶ä¸ŠæŠ¥ç”¨æˆ·åœç•™æ—¶é•¿
window.addEventListener('beforeunload', () => {
  reportData({ event: 'page_unload', duration: Date.now() - pageStartTime });
});
```