# asyncã€awaitä¸generator

https://yuanbao.tencent.com/chat/naQivTmsDa/b63b2d60-59bd-47d9-b62e-11fe6dd4b971?projectId=2f13020843e3426ab5f1fc84dfe2aa87

(calculateFPS)æ˜¯æ€ä¹ˆç»™å‡½æ•°ä¼ å‚çš„

#  `performance.now()` æ˜¯ä»€ä¹ˆï¼Ÿ

`performance.now()` æ˜¯ Web Performance API æä¾›çš„é«˜ç²¾åº¦æ—¶é—´æˆ³æ–¹æ³•ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **é«˜ç²¾åº¦**ï¼šè¿”å›ä»¥æ¯«ç§’ä¸ºå•ä½çš„æ—¶é—´æˆ³ï¼Œç²¾åº¦å¯è¾¾å¾®ç§’çº§ï¼ˆè‡³å°‘0.1msï¼‰
- **ç›¸å¯¹æ—¶é—´**ï¼šè¿”å›ä»é¡µé¢åŠ è½½å¼€å§‹çš„æ—¶é—´ï¼ˆä¸æ˜¯ç³»ç»Ÿæ—¶é—´ï¼‰
- **å•è°ƒé€’å¢**ï¼šä¸å—ç³»ç»Ÿæ—¶é—´è°ƒæ•´å½±å“ï¼Œä¿è¯å§‹ç»ˆé€’å¢
- **ç”¨é€”**ï¼šéå¸¸é€‚åˆç”¨äºæ€§èƒ½æµ‹é‡ã€åŠ¨ç”»è®¡æ—¶ç­‰åœºæ™¯

å¯¹æ¯” `Date.now()`ï¼š

```js
console.log(Date.now());       // è¿”å›è‡ª1970å¹´1æœˆ1æ—¥è‡³ä»Šçš„æ¯«ç§’æ•°ï¼ˆç³»ç»Ÿæ—¶é—´ï¼‰
console.log(performance.now()); // è¿”å›è‡ªé¡µé¢åŠ è½½å¼€å§‹çš„æ¯«ç§’æ•°ï¼ˆé«˜ç²¾åº¦ï¼‰
```

# `requestAnimationFrame` å¦‚ä½•ä¼ é€’æ—¶é—´æˆ³å‚æ•°

`requestAnimationFrame` ä¼šè‡ªåŠ¨å°†é«˜ç²¾åº¦æ—¶é—´æˆ³ä½œä¸ºå‚æ•°ä¼ é€’ç»™å›è°ƒå‡½æ•°ï¼š

```js
requestAnimationFrame((timestamp) => {
  // è¿™ä¸ªtimestampå‚æ•°ç”±æµè§ˆå™¨è‡ªåŠ¨ä¼ å…¥
  console.log(timestamp); // ç±»ä¼¼ performance.now() çš„å€¼
});
```

# Proxyå¯¹è±¡

ğŸ” ä»€ä¹ˆæ˜¯ `Proxy`ï¼Ÿ

> `Proxy` æ˜¯ ES6 å¼•å…¥çš„åŸç”Ÿå¯¹è±¡ï¼Œç”¨äº**åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„ä»£ç†**ï¼Œä»è€Œå¯ä»¥æ‹¦æˆªå’Œè‡ªå®šä¹‰å¯¹è±¡çš„åŸºæœ¬æ“ä½œï¼ˆå¦‚è¯»å–å±æ€§ã€èµ‹å€¼ã€å‡½æ•°è°ƒç”¨ç­‰ï¼‰ã€‚

------

ğŸ§  æ ¸å¿ƒè¯­æ³•

```js
const proxy = new Proxy(target, handler);
```

- `target`ï¼šè¦ä»£ç†çš„å¯¹è±¡ï¼ˆå¯ä»¥æ˜¯å¯¹è±¡ã€æ•°ç»„ã€å‡½æ•°ç­‰ï¼‰
- `handler`ï¼šä¸€ä¸ªå¯¹è±¡ï¼Œå®šä¹‰æ‹¦æˆªé€»è¾‘ï¼ˆç§°ä¸ºâ€œæ•æ‰å™¨â€trapï¼‰

------

ğŸ”§ å¸¸ç”¨çš„æ‹¦æˆªæ“ä½œï¼ˆtrapï¼‰

| trap åç§°        | æ‹¦æˆªè¡Œä¸º               | ç¤ºä¾‹                     |
| ---------------- | ---------------------- | ------------------------ |
| `get`            | è¯»å–å±æ€§               | `proxy.name`             |
| `set`            | è®¾ç½®å±æ€§               | `proxy.name = 'Tom'`     |
| `has`            | åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨       | `'name' in proxy`        |
| `deleteProperty` | åˆ é™¤å±æ€§               | `delete proxy.name`      |
| `apply`          | è°ƒç”¨å‡½æ•°ï¼ˆå‡½æ•°ä»£ç†æ—¶ï¼‰ | `proxyFn()`              |
| `construct`      | ä½¿ç”¨ `new` åˆ›å»ºå®ä¾‹æ—¶  | `new proxyConstructor()` |

------

âœ… ç¤ºä¾‹ 1ï¼šæ‹¦æˆªå¯¹è±¡å±æ€§è¯»å–å’Œå†™å…¥

```js
const user = { name: "Tom", age: 25 };

const proxyUser = new Proxy(user, {
  get(target, prop) {
    console.log("è¯»å–å±æ€§:", prop);
    return target[prop];
  },
  set(target, prop, value) {
    console.log("è®¾ç½®å±æ€§:", prop, "=", value);
    target[prop] = value;
    return true;
  }
});

proxyUser.name;          // æ§åˆ¶å°ï¼šè¯»å–å±æ€§: name
proxyUser.age = 30;      // æ§åˆ¶å°ï¼šè®¾ç½®å±æ€§: age = 30
```

------

âœ… ç¤ºä¾‹ 2ï¼šæ•°ç»„ä¿æŠ¤

```js
const list = [1, 2, 3];

const safeList = new Proxy(list, {
  get(target, prop) {
    if (prop < 0 || prop >= target.length) {
      return undefined;
    }
    return target[prop];
  }
});

console.log(safeList[1]);  // 2
console.log(safeList[99]); // undefinedï¼Œè€Œä¸æ˜¯æŠ›é”™
```

------

âœ… ç¤ºä¾‹ 3ï¼šå‡½æ•°é˜²æŠ–ï¼ˆå‡½æ•°ä»£ç† + applyï¼‰

```js
function search() {
  console.log("è¯·æ±‚æ¥å£:", Date.now());
}

const debouncedSearch = new Proxy(search, {
  apply(target, thisArg, args) {
    clearTimeout(target.timer);
    target.timer = setTimeout(() => target.apply(thisArg, args), 300);
  }
});

window.addEventListener("input", debouncedSearch);
```

------

âœ… ç¤ºä¾‹ 4ï¼šæ„é€ å‡½æ•°ä»£ç†ï¼ˆæ‹¦æˆª newï¼‰

```js
class Person {
  constructor(name) {
    this.name = name;
  }
}

const PersonProxy = new Proxy(Person, {
  construct(target, args) {
    console.log("æ­£åœ¨åˆ›å»ºå®ä¾‹:", args);
    return new target(...args);
  }
});

const p = new PersonProxy("Alice"); // æ§åˆ¶å°ï¼šæ­£åœ¨åˆ›å»ºå®ä¾‹: ["Alice"]
```

------

ğŸ¯ Proxy å¸¸è§ç”¨é€”æ€»ç»“

| ç”¨é€”            | ç¤ºä¾‹                                    |
| --------------- | --------------------------------------- |
| æ•°æ®ä¿æŠ¤        | æ‹¦æˆªéæ³•è®¿é—®æˆ–ä¿®æ”¹å±æ€§                  |
| æ—¥å¿—/ç›‘æ§       | è¯»å–å±æ€§æˆ–è°ƒç”¨å‡½æ•°æ—¶è®°å½•æ—¥å¿—            |
| æ¥å£é˜²æŠ–/èŠ‚æµ   | åŒ…è£…å‡½æ•°æ‰§è¡Œé€»è¾‘                        |
| ç»Ÿä¸€æ ¼å¼è½¬æ¢    | æ‹¦æˆªæ•°æ®è®¿é—®ï¼Œå®ç°å°é©¼å³°/ä¸‹åˆ’çº¿è‡ªåŠ¨è½¬æ¢ |
| è™šæ‹Ÿå±æ€§/æ‡’åŠ è½½ | åªæœ‰è®¿é—®åˆ°æŸå±æ€§æ—¶æ‰çœŸæ­£è®¡ç®—/åŠ è½½       |
| mock æ•°æ®ä»£ç†   | ç”¨äºæµ‹è¯•æˆ–å‰ç«¯ mock                     |

------

ğŸ§  é¢è¯•å»ºè®®å›ç­”æ–¹å¼

> Proxy æ˜¯æˆ‘æ¯”è¾ƒå–œæ¬¢çš„ä¸€ä¸ªç‰¹æ€§ï¼Œåœ¨é¡¹ç›®ä¸­æˆ‘ç”¨å®ƒåšè¿‡æ¥å£ç¼“å­˜ã€è®¿é—®æ§åˆ¶ã€é˜²æŠ–åŒ…è£…ï¼Œè¿˜æ¨¡æ‹Ÿè¿‡å‰ç«¯ mock æ¥å£è¿”å›ã€‚å®ƒç›¸æ¯” Object.defineProperty æ›´çµæ´»ï¼Œæ”¯æŒå‡½æ•°ã€æ•°ç»„ã€æ„é€ å™¨ç­‰çš„æ‹¦æˆªã€‚

------

âš ï¸ æ³¨æ„äº‹é¡¹

- `Proxy` æ˜¯**ä¸å¯ polyfill çš„**ï¼Œåªèƒ½åœ¨æ”¯æŒ ES6 çš„ç¯å¢ƒä½¿ç”¨ã€‚
- Proxy æ€§èƒ½å¼€é”€ç¨é«˜ï¼Œä¸å»ºè®®å¯¹å¤§é‡æ•°æ®é•¿é“¾å¼è®¿é—®åœºæ™¯ä½¿ç”¨ã€‚

# Reflect

> `Reflect` æ˜¯ ES6 å¼•å…¥çš„ä¸€ä¸ªå†…ç½®å¯¹è±¡ï¼Œæä¾›äº†**æ“ä½œå¯¹è±¡çš„ä½çº§æ–¹æ³•é›†åˆ**ï¼Œå’Œ `Object` ç±»ä¼¼ï¼Œä½†æ›´åå‘åº•å±‚è¡Œä¸ºæ§åˆ¶ã€‚

å®ƒçš„ç›®æ ‡æ˜¯ï¼š

- **ç»Ÿä¸€è¯­è¨€å†…éƒ¨æ–¹æ³•çš„è°ƒç”¨æ–¹å¼**
- **ä½œä¸º Proxy trap çš„é»˜è®¤å¤„ç†å‡½æ•°**
- **é¿å…ç ´ååŸå§‹è¡Œä¸ºæˆ–é‡å¤å®ç°åº•å±‚é€»è¾‘**

âœ… å¸¸ç”¨ API åŠè¯´æ˜

| Reflect æ–¹æ³•                       | ç­‰ä»·äº                                 | ç”¨é€”è¯´æ˜                   |
| ---------------------------------- | -------------------------------------- | :------------------------- |
| `Reflect.get(obj, key)`            | `obj[key]`                             | å®‰å…¨åœ°è¯»å–å±æ€§             |
| `Reflect.set(obj, key, val)`       | `obj[key] = val`                       | å®‰å…¨åœ°è®¾ç½®å±æ€§ï¼Œè¿”å›å¸ƒå°”å€¼ |
| `Reflect.has(obj, key)`            | `key in obj`                           | åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨           |
| `Reflect.deleteProperty(obj, key)` | `delete obj[key]`                      | åˆ é™¤å±æ€§                   |
| `Reflect.ownKeys(obj)`             | `Object.getOwnPropertyNames + Symbols` | è·å–æ‰€æœ‰é”®                 |
| `Reflect.defineProperty`           | ç±»ä¼¼ `Object.defineProperty`           | å®šä¹‰å±æ€§                   |
| `Reflect.construct()`              | æ„é€ å‡½æ•°æ‰§è¡Œ `new` è¡Œä¸º                | ç”¨äº Proxy æ„é€ å™¨æ‹¦æˆª      |
| `Reflect.apply()`                  | æ‰§è¡Œå‡½æ•°ï¼ˆç±»ä¼¼ `fn.apply`ï¼‰            | ç”¨äºå‡½æ•°è°ƒç”¨ä»£ç†           |

# Object.iså’Œ===ä»€ä¹ˆåŒºåˆ«

`Object.is` å’Œ `===`ï¼ˆä¸¥æ ¼ç›¸ç­‰ï¼‰åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹è¡¨ç°ä¸€è‡´ï¼Œä½†å®ƒä»¬åœ¨**å°‘æ•°è¾¹ç•Œæƒ…å†µ**æœ‰**æ˜¾è‘—ä¸åŒ**ã€‚

| æƒ…å†µ           | `===` ç»“æœ | `Object.is` ç»“æœ | è¯´æ˜                           |
| -------------- | ---------- | ---------------- | ------------------------------ |
| `+0` å’Œ `-0`   | `true`     | `false`          | `Object.is` åŒºåˆ† +0 å’Œ -0      |
| `NaN` å’Œ `NaN` | `false`    | `true`           | `Object.is` èƒ½åˆ¤æ–­ NaN === NaN |

# æµè§ˆå™¨çš„è¿›ç¨‹ä¸çº¿ç¨‹

æµè§ˆå™¨æ˜¯ä¸€ä¸ªå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹çš„å¤æ‚è½¯ä»¶ç³»ç»Ÿï¼Œä¸ºäº†æå‡**æ€§èƒ½ã€ç¨³å®šæ€§ã€å®‰å…¨æ€§**ï¼Œå®ƒæŠŠä¸åŒæ¨¡å—åˆ†æ•£åœ¨å¤šä¸ªè¿›ç¨‹å’Œçº¿ç¨‹ä¸­ã€‚æˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥è¯¦ç»†ä»‹ç»ï¼š

------

## ä¸€ã€æµè§ˆå™¨çš„ä¸»è¦**è¿›ç¨‹**

ç°ä»£æµè§ˆå™¨ï¼ˆå¦‚ Chromeï¼‰é‡‡ç”¨å¤šè¿›ç¨‹æ¶æ„ï¼Œä»¥ä¸‹æ˜¯ä¸»è¦çš„è¿›ç¨‹ç±»å‹ï¼š

| è¿›ç¨‹å                              | æè¿°                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| **æµè§ˆå™¨ä¸»è¿›ç¨‹ï¼ˆBrowser Processï¼‰** | å”¯ä¸€ä¸€ä¸ªï¼Œè´Ÿè´£åè°ƒã€ç•Œé¢ã€èµ„æºç®¡ç†ã€ç½‘ç»œè¯·æ±‚ã€é¡µé¢è°ƒåº¦ç­‰ã€‚ä¹Ÿç§°UIè¿›ç¨‹ã€‚ |
| **æ¸²æŸ“è¿›ç¨‹ï¼ˆRenderer Processï¼‰**    | æ¯ä¸ª Tab é¡µé¢ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œè´Ÿè´£ HTMLã€CSSã€JS çš„è§£æå’Œæ¸²æŸ“ã€‚   |
| **GPU è¿›ç¨‹**                        | è´Ÿè´£å›¾å½¢ç›¸å…³ä»»åŠ¡ï¼Œå¤„ç†åˆæˆå›¾å±‚ã€åŠ é€Ÿæ¸²æŸ“ã€‚                   |
| **ç½‘ç»œè¿›ç¨‹ï¼ˆNetwork Processï¼‰**     | ç‹¬ç«‹å‡ºæ¥è´Ÿè´£ç½‘ç»œè¯·æ±‚ã€ç¼“å­˜ã€Cookieã€HTTP ç­‰ã€‚                |
| **æ’ä»¶è¿›ç¨‹ï¼ˆå·²è¿‡æ—¶ï¼‰**              | è€ç‰ˆæœ¬ç”¨æ¥è¿è¡Œ Flash ç­‰æ’ä»¶ï¼Œç°åœ¨å·²åŸºæœ¬åºŸå¼ƒã€‚                |
| **æ‰©å±•è¿›ç¨‹**                        | è¿è¡Œæµè§ˆå™¨æ‰©å±•ç¨‹åºï¼Œå¦‚ Chrome æ’ä»¶ã€‚                         |

------

## äºŒã€æ¸²æŸ“è¿›ç¨‹å†…éƒ¨çš„ä¸»è¦çº¿ç¨‹

æ¯ä¸ª**æ¸²æŸ“è¿›ç¨‹**æœ¬èº«æ˜¯å¤šçº¿ç¨‹çš„ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®çº¿ç¨‹ï¼š

| çº¿ç¨‹                                         | èŒè´£                                                         |
| -------------------------------------------- | ------------------------------------------------------------ |
| **ä¸»çº¿ç¨‹ï¼ˆUI/Main Threadï¼‰**                 | æ‰§è¡Œ JSã€è§£æ HTML/CSSã€æ„å»º DOMã€å¤„ç†äº‹ä»¶å¾ªç¯ã€è°ƒåº¦ä»»åŠ¡ç­‰ã€‚æ˜¯ Web å¼€å‘ä¸­æœ€æ ¸å¿ƒçš„çº¿ç¨‹ã€‚ |
| **æ¸²æŸ“çº¿ç¨‹ï¼ˆåˆæˆçº¿ç¨‹ / Compositor Threadï¼‰** | è´Ÿè´£å›¾å±‚åˆæˆã€ç»˜åˆ¶å‰å‡†å¤‡ï¼Œç”¨äºé¡µé¢æ»šåŠ¨ã€åˆæˆåŠ¨ç”»ç­‰ï¼Œç‹¬ç«‹äºä¸»çº¿ç¨‹ã€‚ |
| **JS å¼•æ“çº¿ç¨‹ï¼ˆV8çº¿ç¨‹ï¼‰**                    | V8 JavaScript å¼•æ“åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œæ‰§è¡Œ JS è„šæœ¬ã€‚             |
| **æ ·å¼è®¡ç®—çº¿ç¨‹ / Layout Thread**             | å’Œä¸»çº¿ç¨‹é…åˆï¼Œè®¡ç®— CSSã€å¸ƒå±€ä½ç½®ç­‰ï¼Œé€šå¸¸æ˜¯ä¸»çº¿ç¨‹å¤„ç†ã€‚       |
| **å·¥ä½œçº¿ç¨‹ï¼ˆWeb Workerï¼‰**                   | JS å¯åˆ›å»ºçš„çº¿ç¨‹ï¼Œæ‰§è¡Œè€—æ—¶æ“ä½œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼ˆä½†ä¸èƒ½è®¿é—® DOMï¼‰ã€‚ |
| **å®šæ—¶å™¨çº¿ç¨‹ï¼ˆTimer Threadï¼‰**               | ç®¡ç† `setTimeout`ã€`setInterval` çš„å›è°ƒé˜Ÿåˆ—ä¸è§¦å‘ã€‚          |
| **äº‹ä»¶è§¦å‘çº¿ç¨‹**                             | æ¥è‡ªç½‘ç»œã€è¾“å…¥ã€ç”¨æˆ·æ“ä½œç­‰äº‹ä»¶ä»è¿™é‡Œè¿›å…¥ä¸»çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ã€‚   |
| **çº¿ç¨‹æ± ï¼ˆä¾‹å¦‚ Fetchã€Promiseã€Web APIsï¼‰**  | æµè§ˆå™¨å†…éƒ¨çº¿ç¨‹æ± å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œå¦‚ç½‘ç»œè¯·æ±‚ã€å¼‚æ­¥ I/Oã€‚         |

------

## ä¸‰ã€æ¸²æŸ“æµç¨‹ï¼šçº¿ç¨‹å‚ä¸å…³ç³»

é¡µé¢åŠ è½½å’Œæ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œå„ä¸ªçº¿ç¨‹åä½œå¦‚ä¸‹ï¼š

```plaintext
1. HTML/CSS è§£æï¼ˆä¸»çº¿ç¨‹ï¼‰
2. æ„å»º DOM/CSSOMï¼ˆä¸»çº¿ç¨‹ï¼‰
3. JS æ‰§è¡Œã€ä¿®æ”¹ DOMï¼ˆä¸»çº¿ç¨‹ / V8ï¼‰
4. æ ·å¼è®¡ç®—ã€å¸ƒå±€ï¼ˆä¸»çº¿ç¨‹ï¼‰
5. ç»˜åˆ¶å›¾å±‚ï¼ˆä¸»çº¿ç¨‹ï¼‰
6. å›¾å±‚åˆæˆï¼ˆåˆæˆçº¿ç¨‹ï¼‰
7. GPU åŠ é€Ÿç»˜åˆ¶ï¼ˆGPU è¿›ç¨‹ï¼‰
```

------

## å››ã€å¼‚æ­¥äº‹ä»¶å’Œçº¿ç¨‹å…³ç³»

æµè§ˆå™¨çš„å¼‚æ­¥æœºåˆ¶ï¼ˆEvent Loopï¼‰æ¶‰åŠå¤šä¸ªçº¿ç¨‹ï¼š

### 1. ä¸»çº¿ç¨‹ä¸­çš„ Event Loop

ä¸»çº¿ç¨‹é€šè¿‡äº‹ä»¶å¾ªç¯æœºåˆ¶ç®¡ç†æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ï¼š

- **å®ä»»åŠ¡ï¼ˆMacro Taskï¼‰**ï¼šå¦‚ `setTimeout`ã€`setInterval`ã€`requestAnimationFrame`ã€UI æ¸²æŸ“ã€äº‹ä»¶å›è°ƒã€‚
- **å¾®ä»»åŠ¡ï¼ˆMicro Taskï¼‰**ï¼šå¦‚ `Promise.then`ã€`MutationObserver`ã€queueMicrotaskã€‚

### 2. å…¶ä»–çº¿ç¨‹é…åˆ

| å¼‚æ­¥æœºåˆ¶                   | çº¿ç¨‹æ”¯æŒ                                      | è¯´æ˜                       |
| -------------------------- | --------------------------------------------- | -------------------------- |
| `setTimeout`/`setInterval` | **å®šæ—¶å™¨çº¿ç¨‹** è§¦å‘äº‹ä»¶å›è°ƒ -> ä¼ å…¥ä¸»çº¿ç¨‹æ‰§è¡Œ |                            |
| `fetch`ã€XHR               | **ç½‘ç»œçº¿ç¨‹** å‘èµ·è¯·æ±‚ï¼Œå®Œæˆåè§¦å‘äº‹ä»¶å›è°ƒ     |                            |
| `Web Worker`               | ç‹¬ç«‹çº¿ç¨‹                                      | ä¸èƒ½è®¿é—® DOMï¼Œé€‚åˆå¯†é›†è®¡ç®— |
| `requestIdleCallback`      | ä¸»çº¿ç¨‹ç©ºé—²æ—¶è°ƒåº¦æ‰§è¡Œ                          |                            |
| `requestAnimationFrame`    | åˆæˆçº¿ç¨‹ + ä¸»çº¿ç¨‹                             | ä¸‹æ¬¡é‡ç»˜å‰æ‰§è¡Œï¼Œç”¨äºåŠ¨ç”»   |

------

## äº”ã€æ€»ç»“å›¾ç¤ºï¼šè¿›ç¨‹ä¸çº¿ç¨‹å…³ç³»ï¼ˆç®€åŒ–ï¼‰

```
æµè§ˆå™¨è¿›ç¨‹ï¼ˆUIï¼‰
â”œâ”€â”€ è´Ÿè´£åœ°å€æ ã€ä¹¦ç­¾æ ã€å‰è¿›/åé€€ã€Tab ç®¡ç†
â”‚
â”œâ”€â”€ å¯åŠ¨æ¸²æŸ“è¿›ç¨‹ï¼ˆæ¯ä¸ªé¡µé¢ä¸€ä¸ªï¼‰
â”‚   â”œâ”€â”€ ä¸»çº¿ç¨‹ï¼ˆHTML/CSS/JS æ‰§è¡Œï¼‰
â”‚   â”œâ”€â”€ JS å¼•æ“çº¿ç¨‹ï¼ˆV8ï¼‰
â”‚   â”œâ”€â”€ äº‹ä»¶çº¿ç¨‹ï¼ˆç›‘å¬è¾“å…¥/é¼ æ ‡ï¼‰
â”‚   â”œâ”€â”€ åˆæˆçº¿ç¨‹ï¼ˆç»˜åˆ¶å›¾å±‚ï¼‰
â”‚   â”œâ”€â”€ Timer çº¿ç¨‹ï¼ˆå®šæ—¶å™¨ï¼‰
â”‚   â”œâ”€â”€ Workerçº¿ç¨‹ï¼ˆå¦‚ Web Workerï¼‰
â”‚
â”œâ”€â”€ ç½‘ç»œè¿›ç¨‹ï¼ˆç‹¬ç«‹ï¼‰
â”‚   â””â”€â”€ ç®¡ç† HTTP è¯·æ±‚ï¼Œç¼“å­˜ï¼ŒCookie
â”‚
â””â”€â”€ GPU è¿›ç¨‹ï¼ˆç‹¬ç«‹ï¼‰
    â””â”€â”€ å›¾å½¢ç»˜åˆ¶ã€ç¡¬ä»¶åŠ é€Ÿ
```

------

## å…­ã€é¢è¯•æ€»ç»“è®°å¿†å»ºè®®

- â€œä¸€ä¸ªä¸»è¿›ç¨‹ + å¤šä¸ªæ¸²æŸ“è¿›ç¨‹ + ç½‘ç»œ/GPUç­‰è¾…åŠ©è¿›ç¨‹â€ã€‚
- ä¸»çº¿ç¨‹è´Ÿè´£æ‰§è¡Œ JSã€æ„å»º DOMã€‚
- åˆæˆçº¿ç¨‹ã€GPU åˆ†æ‹… UI ç»˜åˆ¶å‹åŠ›ã€‚
- Web Worker å’Œä¸»çº¿ç¨‹é€šä¿¡ï¼Œç”¨äºå¹¶è¡Œè®¡ç®—ã€‚
- å®šæ—¶å™¨ã€ç½‘ç»œç­‰äº‹ä»¶ç”±åå°çº¿ç¨‹è§¦å‘ï¼Œ**é€šè¿‡äº‹ä»¶å¾ªç¯ä¼ å…¥ä¸»çº¿ç¨‹æ‰§è¡Œå›è°ƒ**ã€‚

## ä¸ƒã€ä¸»çº¿ç¨‹é‡ç‚¹

```css
ğŸ§  æ¸²æŸ“è¿›ç¨‹ï¼ˆRenderer Processï¼‰
â”œâ”€â”€ ğŸ‘¨â€ğŸ’» ä¸»çº¿ç¨‹ï¼ˆMain Threadï¼‰
â”‚   â”œâ”€â”€ ğŸ’¡ åŒ…å« V8 JavaScript å¼•æ“ï¼ˆJS æ‰§è¡Œï¼‰
â”‚   â”œâ”€â”€ ğŸ§± è´Ÿè´£ HTML/CSS è§£æï¼Œæ„å»º DOM/CSSOM
â”‚   â”œâ”€â”€ ğŸ§® è®¡ç®—æ ·å¼ã€å¸ƒå±€
â”‚   â”œâ”€â”€ ğŸ”„ äº‹ä»¶å¾ªç¯ã€å¤„ç†å›è°ƒ
â”‚
â”œâ”€â”€ ğŸ¨ åˆæˆçº¿ç¨‹ï¼ˆCompositor Threadï¼‰
â”‚   â””â”€â”€ åˆæˆå›¾å±‚ï¼Œå‡†å¤‡ GPU ç»˜åˆ¶
â”‚
â”œâ”€â”€ ğŸ“¦ Web Worker çº¿ç¨‹ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ ğŸ•’ å®šæ—¶å™¨çº¿ç¨‹ï¼ˆå¯é€‰ï¼‰
```

**ä¸»çº¿ç¨‹ = åŒ…å«äº† V8 JS å¼•æ“çš„ HTML æ¸²æŸ“è°ƒåº¦çº¿ç¨‹**

V8 JavaScript å¼•æ“çº¿ç¨‹ï¼ˆJS å¼•æ“çº¿ç¨‹ï¼‰:

- å®é™…ä¸Šå¹¶ä¸æ˜¯å•ç‹¬çš„çº¿ç¨‹ï¼Œè€Œæ˜¯**è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ JavaScript å¼•æ“**ã€‚
- Chrome ä½¿ç”¨ V8 å¼•æ“ï¼Œåœ¨ä¸»çº¿ç¨‹å†…æ‰§è¡Œ JS ä»£ç ã€‚
- æ‰€ä»¥ä½ çœ‹åˆ° JS è¿è¡Œæ…¢ã€é˜»å¡é¡µé¢ï¼Œå…¶å®å°±æ˜¯**ä¸»çº¿ç¨‹è¢« JS å ç”¨**ã€‚

# requestIdleCallbackæ˜¯ä»€ä¹ˆ

`requestIdleCallback` æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ª APIï¼Œæ˜¯**æµè§ˆå™¨è°ƒåº¦çš„ä½ä¼˜å…ˆçº§å®ä»»åŠ¡**ï¼Œç”¨äº **åœ¨æµè§ˆå™¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶æ‰§è¡Œéå…³é”®ä»»åŠ¡**ï¼Œä¸ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ã€‚å®ƒé€‚åˆå¤„ç†é‚£äº›**å¯å»¶è¿Ÿæ‰§è¡Œã€éç´§æ€¥çš„ä»»åŠ¡**ï¼Œæ¯”å¦‚é¢„åŠ è½½æ•°æ®ã€æ—¥å¿—ä¸ŠæŠ¥ã€æ‡’åˆå§‹åŒ–ç­‰ã€‚

------

âœ… ä¸€å¥è¯ç†è§£

> `requestIdleCallback` è®©ä½ â€œç­‰æµè§ˆå™¨ç©ºäº†å†è¯´â€ï¼Œä¸ä¼šå½±å“ç”¨æˆ·äº¤äº’å’Œæ¸²æŸ“æ€§èƒ½ã€‚

------

ğŸ“¦ åŸºæœ¬ç”¨æ³•

```js
requestIdleCallback((deadline) => {
  while (deadline.timeRemaining() > 0 && tasks.length > 0) {
    doSomeTask(tasks.shift());
  }
});
```

------

å‚æ•°è§£é‡Š

å›è°ƒå‡½æ•°æ¥æ”¶ä¸€ä¸ª `IdleDeadline` å¯¹è±¡ï¼ŒåŒ…å«ï¼š

| å±æ€§/æ–¹æ³•         | è¯´æ˜                                          |
| ----------------- | --------------------------------------------- |
| `timeRemaining()` | è¿”å›å½“å‰ç©ºé—²æ—¶é—´çš„å‰©ä½™æ¯«ç§’æ•°ï¼ˆä¸€èˆ¬æœ€å¤š 50msï¼‰ |
| `didTimeout`      | å¦‚æœè®¾ç½®äº† `timeout` å¹¶è¶…æ—¶äº†ï¼Œåˆ™ä¸º `true`    |

------

ğŸ§ª ç¤ºä¾‹ï¼šç©ºé—²æ—¶åŠ è½½å›¾ç‰‡

```js
requestIdleCallback((deadline) => {
  while (deadline.timeRemaining() > 0 && imageQueue.length > 0) {
    const img = new Image();
    img.src = imageQueue.shift();
    document.body.appendChild(img);
  }
});
```

------

â± å¯é€‰å‚æ•°ï¼š`timeout`

```js
requestIdleCallback(callback, { timeout: 2000 });
```

> å¦‚æœåœ¨ 2 ç§’å†…å§‹ç»ˆæ²¡æœ‰ç©ºé—²æ—¶é—´ï¼Œå®ƒä¹Ÿä¼šå¼ºåˆ¶æ‰§è¡Œã€‚

------

ğŸ” å¯¹æ¯” `setTimeout`

| ç‰¹ç‚¹             | `requestIdleCallback`  | `setTimeout`         |
| ---------------- | ---------------------- | -------------------- |
| è§¦å‘æ—¶æœº         | æµè§ˆå™¨ç©ºé—²æ—¶           | åˆ°æ—¶é—´ç«‹å³æ‰§è¡Œ       |
| æ˜¯å¦å½±å“æ¸²æŸ“     | âŒ å°½é‡ä¸å½±å“é¡µé¢æµç•…æ€§ | âœ… å¯èƒ½é˜»å¡æ¸²æŸ“æˆ–äº¤äº’ |
| æ˜¯å¦ä¿è¯æŒ‰æ—¶æ‰§è¡Œ | âŒ ä¸ä¿è¯               | âœ… å®šæ—¶åç«‹å³æ‰§è¡Œ     |

------

âš ï¸ æµè§ˆå™¨å…¼å®¹æ€§

- æ”¯æŒåº¦ï¼šä»…ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Edge æ”¯æŒï¼Œ**Safari ä¸æ”¯æŒ**ï¼Œéƒ¨åˆ† Firefox æ”¯æŒï¼‰
- å¯ä»¥ç”¨ polyfill æ›¿ä»£ï¼š

```js
window.requestIdleCallback = window.requestIdleCallback || function (cb) {
  return setTimeout(() => {
    const start = Date.now();
    cb({
      didTimeout: false,
      timeRemaining: () => Math.max(0, 50 - (Date.now() - start))
    });
  }, 1);
};
```

------

ğŸ”§ å®é™…åº”ç”¨åœºæ™¯

- âœ… æ‡’åŠ è½½éé¦–å±å›¾ç‰‡
- âœ… é¦–å±æ¸²æŸ“åä¸ŠæŠ¥æ—¥å¿—æˆ–æ‰“ç‚¹
- âœ… ä½ä¼˜å…ˆçº§çš„ç¼“å­˜é¢„çƒ­
- âœ… å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åˆå§‹åŒ–å¤§é‡æŒ‰é’®æˆ–æ¨¡å—

------

# Web Workerå’ŒService Worker

`Web Worker` å’Œ `Service Worker` æ˜¯æµè§ˆå™¨ä¸­ç”¨äº **å¤šçº¿ç¨‹å¤„ç†** çš„ä¸¤ç§ä¸åŒçš„ Web APIï¼Œå®ƒä»¬çš„è®¾è®¡åˆè¡·å’Œä½¿ç”¨åœºæ™¯ä¸åŒï¼Œä½†éƒ½å¯ä»¥åœ¨ä¸é˜»å¡ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹æå‡ Web åº”ç”¨çš„æ€§èƒ½ä¸å“åº”é€Ÿåº¦ã€‚

## ä¸€ã€Web Worker

âœ… å®šä¹‰ï¼š

Web Worker å…è®¸ä½ åœ¨ä¸»çº¿ç¨‹ä¹‹å¤–è¿è¡Œ JavaScript è„šæœ¬ï¼Œå³ **åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œä»£ç **ï¼Œé¿å…é˜»å¡ UIã€‚

âœ… ç‰¹ç‚¹ï¼š

- åªèƒ½ä¸ä¸»çº¿ç¨‹é€šè¿‡ `postMessage` é€šä¿¡ï¼ˆæ¶ˆæ¯ä¼ é€’æ–¹å¼ï¼‰
- æ²¡æœ‰ DOM è®¿é—®æƒé™
- é€‚åˆè¿›è¡Œ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œå¦‚å¤§è®¡ç®—ã€è§£æç­‰
- ç”Ÿå‘½å‘¨æœŸéšé¡µé¢èµ°ï¼ˆé¡µé¢å…³é—­å°±ç»“æŸï¼‰

âœ… ç¤ºä¾‹ï¼š

```js
// main.js
const worker = new Worker('worker.js');
worker.postMessage('start'); // å‘é€æ¶ˆæ¯ç»™ Worker

worker.onmessage = function(e) {
  console.log('Message from worker:', e.data);
};

// worker.js
onmessage = function(e) {
  if (e.data === 'start') {
    let sum = 0;
    for (let i = 0; i < 1e8; i++) sum += i;
    postMessage(sum); // æŠŠç»“æœå‘é€å›ä¸»çº¿ç¨‹
  }
};
```

------

## äºŒã€Service Worker

âœ… å®šä¹‰ï¼š

Service Worker æ˜¯ä¸€ç§ **å¯æ‹¦æˆªç½‘ç»œè¯·æ±‚å¹¶è¿›è¡Œç¼“å­˜æ§åˆ¶çš„ç‹¬ç«‹çº¿ç¨‹**ï¼Œè¿è¡Œåœ¨æµè§ˆå™¨åå°ï¼Œç”¨äºå®ç°ç¦»çº¿ç¼“å­˜ã€èµ„æºé¢„å–ã€æ¶ˆæ¯æ¨é€ç­‰åŠŸèƒ½ã€‚

âœ… ç‰¹ç‚¹ï¼š

- å·¥ä½œäºæµè§ˆå™¨å’Œç½‘ç»œä¹‹é—´ï¼Œç±»ä¼¼ä¸€ä¸ªä»£ç†æœåŠ¡å™¨
- ç”Ÿå‘½å‘¨æœŸä¸é¡µé¢æ— å…³ï¼ˆå³ä½¿é¡µé¢å…³é—­ï¼ŒService Worker ä»å¯è¿è¡Œï¼‰
- æœ‰è®¿é—® Cache APIã€Fetch API çš„èƒ½åŠ›
- ä¸»è¦ç”¨äºç¦»çº¿åº”ç”¨ã€ç¼“å­˜ä¼˜åŒ–ã€æ¶ˆæ¯æ¨é€ï¼ˆå¦‚ PWAï¼‰

âœ… ç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼š

1. `register`ï¼šæ³¨å†Œ Service Worker
2. `install`ï¼šä¸‹è½½å’Œå®‰è£…
3. `activate`ï¼šæ¿€æ´»æ—§çš„ Worker ç‰ˆæœ¬
4. æ‹¦æˆªè¯·æ±‚ `fetch`ï¼šç¼“å­˜æˆ–å“åº”èµ„æº

âœ… ç¤ºä¾‹ï¼š

```js
// main.js
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(reg => console.log('Service Worker æ³¨å†ŒæˆåŠŸ'))
    .catch(err => console.error('æ³¨å†Œå¤±è´¥:', err));
}

// sw.js
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open('my-cache').then(cache => cache.add('/index.html'))
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(resp => resp || fetch(event.request))
  );
});
```

------

## ä¸‰ã€å¯¹æ¯”æ€»ç»“ï¼š

| é¡¹ç›®         | Web Worker         | Service Worker            |
| ------------ | ------------------ | ------------------------- |
| å·¥ä½œçº¿ç¨‹     | åå°çº¿ç¨‹           | æµè§ˆå™¨åå°çº¿ç¨‹            |
| ä¸ä¸»çº¿ç¨‹å…³ç³» | é€šä¿¡å¼äº¤äº’         | ä¸ç›´æ¥ä¸ DOM æˆ–ä¸»çº¿ç¨‹äº¤äº’ |
| ç”Ÿå‘½å‘¨æœŸ     | éšé¡µé¢ç”Ÿå‘½å‘¨æœŸ     | ç‹¬ç«‹äºé¡µé¢ï¼Œæ”¯æŒæŒä¹…åŒ–    |
| æ˜¯å¦æ‹¦æˆªè¯·æ±‚ | âŒ                  | âœ… å¯ä»¥æ‹¦æˆªå¹¶å¤„ç† fetch    |
| æ˜¯å¦è®¿é—® DOM | âŒ                  | âŒ                         |
| é€‚ç”¨åœºæ™¯     | å¤§é‡è®¡ç®—ã€è€—æ—¶é€»è¾‘ | ç¦»çº¿ç¼“å­˜ã€PWAã€æ¶ˆæ¯æ¨é€   |

------

## å››ã€é¢è¯•å»ºè®®

Q: Web Worker å’Œ Service Worker æœ‰å“ªäº›å¼‚åŒï¼Ÿ

ç­”ï¼š

- ç›¸åŒç‚¹ï¼šéƒ½è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œä¸èƒ½è®¿é—® DOMï¼Œé€šè¿‡ `postMessage` è¿›è¡Œé€šä¿¡ã€‚
- ä¸åŒç‚¹ï¼š
  - Web Worker ç”¨äº**è®¡ç®—å¯†é›†å‹ä»»åŠ¡**ï¼›
  - Service Worker ç”¨äº**ç½‘ç»œä»£ç†ã€ç¼“å­˜ç®¡ç†ã€ç¦»çº¿èƒ½åŠ›**ï¼Œè¿è¡Œåœ¨æµè§ˆå™¨åå°ã€‚

# IntersectionObserver vs scroll äº‹ä»¶ç›‘å¬

åœ¨ç°ä»£æµè§ˆå™¨APIä¸­ï¼ŒIntersectionObserverçš„è§‚å¯ŸintersectingçŠ¶æ€ï¼ˆå³æ£€æµ‹å…ƒç´ ç›¸äº¤å˜åŒ–çš„è¿‡ç¨‹ï¼‰æ˜¯åœ¨Compositor Threadï¼ˆåˆæˆçº¿ç¨‹ï¼‰å®Œæˆçš„ï¼Œè€ŒéMain Threadï¼ˆä¸»çº¿ç¨‹ï¼‰ã€‚è¿™è®¾è®¡æ˜¯ä¸ºäº†é¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œæé«˜æ€§èƒ½ï¼Œå°¤å…¶åœ¨æ»šåŠ¨æˆ–åŠ¨ç”»åœºæ™¯ä¸‹ã€‚

ä¾‹å¦‚ï¼ŒMDNæ–‡æ¡£ä¸­æŒ‡å‡ºï¼Œè¿™ç§APIå…è®¸æµè§ˆå™¨åœ¨ä¸ä¾èµ–ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹ç®¡ç†ç›¸äº¤æ£€æµ‹ï¼Œä»è€Œä¼˜åŒ–æ€§èƒ½ã€‚ ä¸è¿‡ï¼Œè§‚å¯Ÿå™¨çš„å›è°ƒå‡½æ•°ï¼ˆcallbackï¼‰åˆ™ä¼šåœ¨Main Threadä¸Šæ‰§è¡Œï¼Œå› æ­¤å›è°ƒåº”å°½é‡é«˜æ•ˆï¼Œä»¥å…å½±å“ä¸»çº¿ç¨‹çš„å“åº”ã€‚

| å¯¹æ¯”ç»´åº¦             | **IntersectionObserver**                           | **scroll äº‹ä»¶ç›‘å¬**                                       |
| -------------------- | -------------------------------------------------- | --------------------------------------------------------- |
| **è§¦å‘æœºåˆ¶**         | ç”±æµè§ˆå™¨ç»Ÿä¸€è°ƒåº¦ï¼Œå¼‚æ­¥è§¦å‘                         | æ¯æ¬¡æ»šåŠ¨åŒæ­¥è§¦å‘                                          |
| **å›è°ƒæ‰§è¡Œæ—¶æœº**     | å¼‚æ­¥æ‰§è¡Œï¼Œè°ƒåº¦åœ¨ä¸»çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä¸ä¼šæ‰“æ–­ä¸»æµç¨‹ | åŒæ­¥æ‰§è¡Œï¼Œç«‹å³åœ¨ä¸»çº¿ç¨‹ä¸­è§¦å‘                              |
| **æ‰§è¡Œçº¿ç¨‹**         | ä¸»çº¿ç¨‹ï¼ˆç”±æµè§ˆå™¨åœ¨ layout é˜¶æ®µè¿›è¡Œäº¤å‰æ£€æµ‹ï¼‰       | ä¸»çº¿ç¨‹                                                    |
| **æ˜¯å¦é˜»å¡ä¸»çº¿ç¨‹**   | âŒ å›è°ƒä¸ä¼šé˜»å¡ï¼ˆå¼‚æ­¥ï¼‰ â—ï¸ä½†äº¤å‰æ£€æµ‹ä¾èµ– layout é˜¶æ®µ | âœ… å›è°ƒåŒæ­¥æ‰§è¡Œï¼Œ**å¯èƒ½é˜»å¡**ä¸»çº¿ç¨‹                        |
| **æ˜¯å¦ä¾èµ– layout**  | âœ… æ˜¯ï¼Œæµè§ˆå™¨åœ¨æ¯å¸§ layout æ—¶åˆ¤æ–­æ˜¯å¦äº¤å‰           | ä¸ä¾èµ– layout æœ¬èº«ï¼Œåªè¦å‘ç”Ÿæ»šåŠ¨å°±è§¦å‘                    |
| **æ˜¯å¦é¢‘ç¹è§¦å‘**     | âŒ ä¸é¢‘ç¹ï¼Œåªæœ‰äº¤å‰çŠ¶æ€å‘ç”Ÿå˜åŒ–æ‰è§¦å‘               | âœ… éå¸¸é¢‘ç¹ï¼Œæ¯æ¬¡æ»šåŠ¨éƒ½ä¼šè§¦å‘ï¼ˆå³ä½¿æ²¡å˜åŒ–ï¼‰                |
| **æ˜¯å¦æ”¯æŒèŠ‚æµ**     | âœ… æµè§ˆå™¨è‡ªåŠ¨èŠ‚æµè°ƒåº¦                               | âŒ æ‰‹åŠ¨ä½¿ç”¨ `throttle` æˆ– `requestAnimationFrame` æ‰èƒ½ä¼˜åŒ– |
| **é€‚åˆåœºæ™¯**         | - æ‡’åŠ è½½å›¾ç‰‡ - å…ƒç´ æ›å…‰ç»Ÿè®¡ - é¡µé¢è¿›å…¥åŠ¨ç”»ç­‰       | - ç²¾ç¡®å“åº”æ»šåŠ¨ä½ç½® - æ»šåŠ¨è¿›åº¦æ¡ - æ— é™æ»šåŠ¨                |
| **æ˜¯å¦æ”¯æŒ passive** | ğŸš« ä¸é€‚ç”¨ï¼ˆæ²¡æœ‰ preventDefaultï¼‰                    | âœ… æ¨è `{ passive: true }` æé«˜æ»šåŠ¨æ€§èƒ½                   |
| **å¯¹åˆæˆçº¿ç¨‹çš„ä¾èµ–** | âŒ ä¸ä¾èµ–ï¼Œäº¤å‰æ£€æµ‹åœ¨ä¸»çº¿ç¨‹å®Œæˆ                     | âŒ ä¸ä¾èµ–ï¼Œä¸»çº¿ç¨‹å®Œæˆå¤„ç†                                  |

`passive: true` **ä¸ä¼šæ”¹å˜ `scroll` å›è°ƒæ˜¯åŒæ­¥æ‰§è¡Œçš„æœ¬è´¨**ï¼Œä½†å®ƒ**å…è®¸æµè§ˆå™¨æå‰æ»šåŠ¨é¡µé¢**ï¼Œä¸ä¼šè¢« JS å›è°ƒâ€œé˜»å¡æ»šåŠ¨è¡Œä¸ºâ€ã€‚

| ç‰¹æ€§                          | `passive: false`ï¼ˆé»˜è®¤ï¼‰ | `passive: true`    |
| ----------------------------- | ------------------------ | ------------------ |
| å›è°ƒæ˜¯å¦ä»ç„¶åŒæ­¥æ‰§è¡Œ          | âœ… æ˜¯                     | âœ… æ˜¯               |
| æµè§ˆå™¨æ˜¯å¦ç­‰å›è°ƒæ‰§è¡Œå®Œå†æ»šåŠ¨  | âœ… æ˜¯                     | âŒ å¦ï¼ˆå¯ç›´æ¥æ»šåŠ¨ï¼‰ |
| æ˜¯å¦èƒ½è°ƒç”¨ `preventDefault()` | âœ… å¯ä»¥                   | âŒ ä¸å¯ä»¥           |
| æ˜¯å¦èƒ½ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½            | âŒ å¦                     | âœ… æ˜¯               |

# classï¼Œæ€ä¹ˆå¯ä»¥é€šè¿‡sizeæ‹¿å±æ€§ï¼Œè€Œä¸æ˜¯size()

**ä½¿ç”¨ Getterï¼ˆæ¨èï¼‰**

åœ¨ `class` ä¸­ä½¿ç”¨ `get` å…³é”®å­—å®šä¹‰ä¸€ä¸ª **getter**ï¼Œè¿™æ · `size` ä¼šåƒå±æ€§ä¸€æ ·è¢«è®¿é—®ï¼š

**ç¤ºä¾‹ä»£ç **

```js
class MyCollection {
  constructor() {
    this._items = []; // å†…éƒ¨å­˜å‚¨æ•°æ®
  }

  // å®šä¹‰ getterï¼Œå…è®¸é€šè¿‡ .size è®¿é—®
  get size() {
    return this._items.length;
  }

  // å…¶ä»–æ–¹æ³•
  add(item) {
    this._items.push(item);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const collection = new MyCollection();
collection.add(1);
collection.add(2);
collection.add(3);

console.log(collection.size); // 3ï¼ˆä¸æ˜¯ collection.size()ï¼‰
```

# Symbol.abcå’ŒSymbol('abc')ä»€ä¹ˆåŒºåˆ«

`Symbol.abc` å’Œ `Symbol('abc')` çœ‹èµ·æ¥ç±»ä¼¼ï¼Œä½†å®ƒä»¬æœ¬è´¨ä¸Šæ˜¯**å®Œå…¨ä¸åŒçš„ä¸œè¥¿**ã€‚ä¸‹é¢æˆ‘ä»¬æ¥é€ç‚¹å¯¹æ¯”è¯´æ˜ï¼š

------

âœ… ä¸€å¥è¯åŒºåˆ«

- `Symbol('abc')` æ˜¯åˆ›å»ºä¸€ä¸ª**æ–°çš„å”¯ä¸€ Symbol**ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¸ä¸€æ ·ã€‚
- `Symbol.abc` æ˜¯è®¿é—® `Symbol` å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼ˆé€šå¸¸æ˜¯**undefined**ï¼Œé™¤éä½ æ‰‹åŠ¨è®¾ç½®äº†å®ƒï¼‰ã€‚

------

ğŸ” `Symbol('abc')` æ˜¯åˆ›å»ºæ–°çš„ Symbol

```js
const s1 = Symbol('abc')
const s2 = Symbol('abc')

console.log(s1 === s2) // falseï¼Œä¸åŒçš„ symbol
```

- `Symbol('abc')` ä¸­çš„ `'abc'` åªæ˜¯**æè¿°ï¼ˆdescriptionï¼‰**ï¼Œå¯¹è°ƒè¯•æœ‰å¸®åŠ©ï¼Œä½†ä¸å½±å“å”¯ä¸€æ€§ã€‚
- æ¯æ¬¡è°ƒç”¨ `Symbol('abc')` éƒ½ä¼šè¿”å›ä¸€ä¸ª**å…¨æ–°å”¯ä¸€çš„ Symbol**ã€‚

------

ğŸ” `Symbol.abc` æ˜¯è®¿é—® `Symbol` ä¸Šçš„ä¸€ä¸ªå±æ€§

```js
console.log(Symbol.abc) // undefined
```

- `Symbol.abc` ç›¸å½“äºè®¿é—® `Symbol` å¯¹è±¡çš„ `abc` å±æ€§ï¼Œé™¤éä½ æå‰è®¾ç½®äº†è¿™ä¸ªå±æ€§ã€‚
- å®ƒ**ä¸ä¼šåˆ›å»º Symbol**ï¼Œä¹Ÿä¸æ˜¯å†…å»ºçš„ Symbolï¼ˆåƒ `Symbol.iterator` æ˜¯å†…å»ºçš„ï¼‰

------

âœ… çœŸæ­£çš„å†…ç½® Symbol æ˜¯ `Symbol.iterator` è¿™ç±»

```js
console.log(Symbol.iterator) // Symbol(Symbol.iterator)
```

- è¿™äº›æ˜¯ JS æ ‡å‡†ä¸­å®šä¹‰çš„â€œå†…ç½® Symbolâ€ã€‚
- `Symbol.iterator`, `Symbol.toStringTag`, `Symbol.asyncIterator` ç­‰æ˜¯ JS ç³»ç»ŸåŠŸèƒ½çš„ä¸€éƒ¨åˆ†ã€‚

------

ğŸ§ª å¦‚æœä½ æ‰‹åŠ¨è®¾ç½®äº† `Symbol.abc`

```js
Symbol.abc = Symbol('abc')

console.log(Symbol.abc === Symbol.abc) // true
```

- ä½ å¯ä»¥äººä¸ºè®¾ç½® `Symbol.abc` ä¸ºæŸä¸ª Symbolã€‚
- ä½†è¿™æ˜¯**è‡ªå®šä¹‰è¡Œä¸º**ï¼ŒJS æœ¬èº«ä¸æä¾› `Symbol.abc`ã€‚

------

âœ… æ€»ç»“å¯¹æ¯”è¡¨

| è¡¨è¾¾å¼          | ç±»å‹             | æ˜¯å¦å”¯ä¸€ | ç”¨é€”                                        |
| --------------- | ---------------- | -------- | ------------------------------------------- |
| `Symbol('abc')` | Symbol           | âœ… æ˜¯     | åˆ›å»ºæ–°çš„å”¯ä¸€ Symbol                         |
| `Symbol.abc`    | ä¸€èˆ¬ä¸º undefined | âŒ å¦     | è®¿é—® `Symbol` å¯¹è±¡çš„å±æ€§ï¼ŒJS æœ¬èº«æ²¡æœ‰å®šä¹‰å®ƒ |

------

ğŸ“ å®æˆ˜å»ºè®®

- **éœ€è¦åˆ›å»ºå”¯ä¸€æ ‡è¯†**æ—¶ï¼Œç”¨ `Symbol('desc')`
- **ä¸è¦è¯¯ç”¨ `Symbol.abc`**ï¼Œé™¤éä½ è‡ªå·±åœ¨ä»£ç ä¸­å®šä¹‰äº†å®ƒã€‚

å¦‚ä½ æƒ³å¤ç”¨ Symbolï¼Œè¿˜å¯ä»¥è€ƒè™‘ï¼š

ğŸ” ä½¿ç”¨ `Symbol.for('abc')`ï¼šæ³¨å†Œå…¨å±€ Symbol

```js
const a = Symbol.for('abc')
const b = Symbol.for('abc')

console.log(a === b) // trueï¼Œå…¨å±€æ³¨å†Œçš„ Symbol
```

è¿™æ˜¯å”¯ä¸€å¯ä»¥é€šè¿‡å­—ç¬¦ä¸²å¤ç”¨ Symbol çš„æ–¹å¼ã€‚

# TypeErrorå’ŒReferenceErrorä»€ä¹ˆåŒºåˆ«

âœ… é¢è¯•å£è¯­åŒ–è§£é‡Šï¼ˆå¯ç”¨äºå›ç­”ï¼‰

> - `TypeError` æ˜¯å› ä¸ºä½ **å¯¹ç±»å‹åšäº†ä¸åˆé€‚çš„æ“ä½œ**ï¼Œæ¯”å¦‚å¯¹ `undefined` è®¿é—®å±æ€§ã€æŠŠæ•°å­—å½“å‡½æ•°è°ƒç”¨ç­‰ã€‚
> - `ReferenceError` åˆ™æ˜¯ä½ **ç”¨äº†ä¸€ä¸ªæ ¹æœ¬æ²¡å®šä¹‰çš„å˜é‡**ï¼Œå¸¸è§äºæ‹¼é”™å˜é‡åæˆ–å˜é‡ä¸åœ¨ä½œç”¨åŸŸä¸­ã€‚

```js
// ReferenceError: foo is not defined
console.log(foo)    

// TypeError: Cannot read properties of undefined
const user = undefined
console.log(user.name)
```

#  `isNaN` å’Œ `Number.isNaN` çš„åŒºåˆ«

ğŸ“Œ å·®å¼‚ï¼š

- `isNaN(value)` ä¼š**å…ˆå¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—**ï¼Œå†åˆ¤æ–­æ˜¯å¦æ˜¯ NaN â†’ å¯èƒ½è¯¯åˆ¤ã€‚
- `Number.isNaN(value)` æ›´ä¸¥æ ¼ï¼Œåªåœ¨å€¼æœ¬èº«æ˜¯ NaN æ—¶æ‰è¿”å› trueã€‚

ç¤ºä¾‹ï¼š

```js
console.log(isNaN('abc')); // true âŒ é”™è¯¯åˆ¤æ–­
console.log(Number.isNaN('abc')); // false âœ… æ­£ç¡®

console.log(isNaN(NaN)); // true
console.log(Number.isNaN(NaN)); // true
```

# åœ¨ JavaScript ä¸­è·å–ä¸€ä¸ª DOM å…ƒç´ çš„ä½ç½®ï¼ˆç›¸å¯¹äºè§†å£æˆ–é¡µé¢ï¼‰

------

âœ… 1. `getBoundingClientRect()` â€”â€” ç›¸å¯¹äº**è§†å£**

```js
const element = document.querySelector('#myElement');
const rect = element.getBoundingClientRect();

console.log(rect.top, rect.left); // å…ƒç´ ç›¸å¯¹äºè§†å£çš„è·ç¦»
```

è¿”å›å­—æ®µï¼š

| å±æ€§               | å«ä¹‰                                           |
| ------------------ | ---------------------------------------------- |
| `top` / `left`     | å…ƒç´ é¡¶éƒ¨/å·¦è¾¹ åˆ°è§†å£é¡¶éƒ¨/å·¦è¾¹çš„è·ç¦»ï¼ˆå•ä½ pxï¼‰ |
| `bottom` / `right` | å…ƒç´ åº•éƒ¨/å³è¾¹ åˆ°è§†å£çš„è·ç¦»                     |
| `width` / `height` | å…ƒç´ å®½é«˜                                       |

------

âœ… 2. è·å–ç›¸å¯¹äº**æ•´ä¸ªæ–‡æ¡£**çš„åæ ‡ï¼ˆè€ƒè™‘æ»šåŠ¨ï¼‰

```js
const rect = element.getBoundingClientRect();
const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

const offsetTop = rect.top + scrollTop;
const offsetLeft = rect.left + scrollLeft;

console.log(offsetTop, offsetLeft); // ç›¸å¯¹äºæ•´ä¸ªé¡µé¢ï¼ˆdocumentï¼‰çš„ä½ç½®
```

------

âœ… 3. `offsetTop` / `offsetLeft` â€”â€” ç›¸å¯¹äº**offsetParent**

```js
const top = element.offsetTop;
const left = element.offsetLeft;
```

âš ï¸ æ³¨æ„ï¼šè¿™ä¸ªå€¼æ˜¯**ç›¸å¯¹äºå…¶ offsetParent çš„è·ç¦»**ï¼Œä¸æ˜¯é¡µé¢æˆ–è§†å£ã€‚

------

ğŸ” æ¨èç”¨æ³•æ€»ç»“ï¼š

| ç›®æ ‡                                     | æ–¹æ³•                                      |
| ---------------------------------------- | ----------------------------------------- |
| è·å–å…ƒç´ ç›¸å¯¹äº**è§†å£**çš„ä½ç½®             | `element.getBoundingClientRect()`         |
| è·å–å…ƒç´ ç›¸å¯¹äº**é¡µé¢**çš„ä½ç½®ï¼ˆè€ƒè™‘æ»šåŠ¨ï¼‰ | `getBoundingClientRect() + scroll offset` |
| è·å–å…ƒç´ ç›¸å¯¹äº**æœ€è¿‘çš„å®šä½ç¥–å…ˆ**çš„ä½ç½®   | `element.offsetTop / offsetLeft`          |

# e.target !== ref.currentå’Œ!ref.current.contains(e.target)ä»€ä¹ˆåŒºåˆ«

------

âœ… å†™æ³•ä¸€ï¼š

```
e.target !== ref.current
```

ğŸ“Œ å«ä¹‰ï¼š

- äº‹ä»¶ç›®æ ‡ **ä¸¥æ ¼ç­‰äº ref.current** æ‰ä¸º true
- ğŸš« **ä¸èƒ½è¯†åˆ«å­å…ƒç´ **
- åªåŒ¹é… **å…ƒç´ æœ¬èº«**

âœ… ç”¨äºåˆ¤æ–­ï¼š

æ˜¯å¦ **ç‚¹å‡»çš„æ­£æ˜¯è¯¥å…ƒç´ æœ¬èº«**ï¼ˆä¸åŒ…æ‹¬å­å…ƒç´ ï¼‰

------

âœ… å†™æ³•äºŒï¼š

```
!ref.current.contains(e.target)
```

ğŸ“Œ å«ä¹‰ï¼š

- `ref.current.contains` æ˜¯ä¸€ä¸ª **DOM API**ï¼Œç”¨äºåˆ¤æ–­ä¸€ä¸ª DOM èŠ‚ç‚¹æ˜¯å¦**åŒ…å«å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆåŒ…æ‹¬è‡ªèº«æˆ–å­èŠ‚ç‚¹ï¼‰**
- åˆ¤æ–­äº‹ä»¶ç›®æ ‡ `e.target` æ˜¯å¦**ä¸åœ¨è¯¥å…ƒç´ æˆ–å…¶å­å­™å…ƒç´ ä¸­**
- âœ… ä¼šè¯†åˆ«å­å…ƒç´ 
- æ›´å¸¸ç”¨äº**åˆ¤æ–­ç‚¹å‡»æ˜¯å¦å‘ç”Ÿåœ¨å…ƒç´ å¤–éƒ¨**

âœ… ç”¨äºåˆ¤æ–­ï¼š

æ˜¯å¦ **ç‚¹å‡»å‘ç”Ÿåœ¨è¯¥å…ƒç´ ä¹‹å¤–**

------

ğŸ” ä¸¾ä¸ªä¾‹å­ï¼š

```
<div ref="box">
  <button>Click me</button>
</div>
```

ç‚¹å‡» `<button>` æ—¶ï¼š

| åˆ¤æ–­                              | ç»“æœ                                    |
| --------------------------------- | --------------------------------------- |
| `e.target !== ref.current`        | âœ… `true`ï¼Œå› ä¸ºç‚¹å‡»çš„æ˜¯ buttonï¼Œä¸æ˜¯ box |
| `!ref.current.contains(e.target)` | âŒ `false`ï¼Œå› ä¸º button æ˜¯ box çš„å­å…ƒç´   |

âœ… æ€»ç»“ï¼š

| è¡¨è¾¾å¼                            | æ˜¯å¦åŒ…å«å­å…ƒç´  | å¸¸ç”¨äº                                               |
| --------------------------------- | -------------- | ---------------------------------------------------- |
| `e.target !== ref.current`        | âŒ ä¸åŒ…å«       | åˆ¤æ–­æ˜¯å¦ç‚¹å‡»**å…ƒç´ æœ¬èº«**                             |
| `!ref.current.contains(e.target)` | âœ… åŒ…å«         | åˆ¤æ–­æ˜¯å¦ç‚¹å‡»**å…ƒç´ ä¹‹å¤–**ï¼ˆå¸¸ç”¨äºç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—ç­‰ï¼‰ |

# Setå’ŒMapçš„é¡ºåºé—®é¢˜

```js
const set = new Set()
set.add('a')
set.add('b')
set.add('a')

console.log(set)
// Set(2) { 'a', 'b' }

const map = new Map()
map.set('a', 'A')
map.set('b', 'B')
map.set('a', 'newA')

console.log(map)
// Map(2) { 'a' => 'newA', 'b' => 'B' }
```

