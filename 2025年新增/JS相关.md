# asyncã€awaitä¸generator

https://yuanbao.tencent.com/chat/naQivTmsDa/b63b2d60-59bd-47d9-b62e-11fe6dd4b971?projectId=2f13020843e3426ab5f1fc84dfe2aa87

(calculateFPS)æ˜¯æ€ä¹ˆç»™å‡½æ•°ä¼ å‚çš„

#  `performance.now()` æ˜¯ä»€ä¹ˆï¼Ÿ

`performance.now()` æ˜¯ Web Performance API æä¾›çš„é«˜ç²¾åº¦æ—¶é—´æˆ³æ–¹æ³•ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **é«˜ç²¾åº¦**ï¼šè¿”å›ä»¥æ¯«ç§’ä¸ºå•ä½çš„æ—¶é—´æˆ³ï¼Œç²¾åº¦å¯è¾¾å¾®ç§’çº§ï¼ˆè‡³å°‘0.1msï¼‰
- **ç›¸å¯¹æ—¶é—´**ï¼šè¿”å›ä»é¡µé¢åŠ è½½å¼€å§‹çš„æ—¶é—´ï¼ˆä¸æ˜¯ç³»ç»Ÿæ—¶é—´ï¼‰
- **å•è°ƒé€’å¢**ï¼šä¸å—ç³»ç»Ÿæ—¶é—´è°ƒæ•´å½±å“ï¼Œä¿è¯å§‹ç»ˆé€’å¢
- **ç”¨é€”**ï¼šéå¸¸é€‚åˆç”¨äºæ€§èƒ½æµ‹é‡ã€åŠ¨ç”»è®¡æ—¶ç­‰åœºæ™¯

å¯¹æ¯” `Date.now()`ï¼š

```js
console.log(Date.now());       // è¿”å›è‡ª1970å¹´1æœˆ1æ—¥è‡³ä»Šçš„æ¯«ç§’æ•°ï¼ˆç³»ç»Ÿæ—¶é—´ï¼‰
console.log(performance.now()); // è¿”å›è‡ªé¡µé¢åŠ è½½å¼€å§‹çš„æ¯«ç§’æ•°ï¼ˆé«˜ç²¾åº¦ï¼‰
```

# `requestAnimationFrame` å¦‚ä½•ä¼ é€’æ—¶é—´æˆ³å‚æ•°

`requestAnimationFrame` ä¼šè‡ªåŠ¨å°†é«˜ç²¾åº¦æ—¶é—´æˆ³ä½œä¸ºå‚æ•°ä¼ é€’ç»™å›è°ƒå‡½æ•°ï¼š

```js
requestAnimationFrame((timestamp) => {
  // è¿™ä¸ªtimestampå‚æ•°ç”±æµè§ˆå™¨è‡ªåŠ¨ä¼ å…¥
  console.log(timestamp); // ç±»ä¼¼ performance.now() çš„å€¼
});
```

# Proxyå¯¹è±¡

## ğŸ” ä»€ä¹ˆæ˜¯ `Proxy`ï¼Ÿ

> `Proxy` æ˜¯ ES6 å¼•å…¥çš„åŸç”Ÿå¯¹è±¡ï¼Œç”¨äº**åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„ä»£ç†**ï¼Œä»è€Œå¯ä»¥æ‹¦æˆªå’Œè‡ªå®šä¹‰å¯¹è±¡çš„åŸºæœ¬æ“ä½œï¼ˆå¦‚è¯»å–å±æ€§ã€èµ‹å€¼ã€å‡½æ•°è°ƒç”¨ç­‰ï¼‰ã€‚

------

## ğŸ§  æ ¸å¿ƒè¯­æ³•

```js
const proxy = new Proxy(target, handler);
```

- `target`ï¼šè¦ä»£ç†çš„å¯¹è±¡ï¼ˆå¯ä»¥æ˜¯å¯¹è±¡ã€æ•°ç»„ã€å‡½æ•°ç­‰ï¼‰
- `handler`ï¼šä¸€ä¸ªå¯¹è±¡ï¼Œå®šä¹‰æ‹¦æˆªé€»è¾‘ï¼ˆç§°ä¸ºâ€œæ•æ‰å™¨â€trapï¼‰

------

## ğŸ”§ å¸¸ç”¨çš„æ‹¦æˆªæ“ä½œï¼ˆtrapï¼‰

| trap åç§°        | æ‹¦æˆªè¡Œä¸º               | ç¤ºä¾‹                     |
| ---------------- | ---------------------- | ------------------------ |
| `get`            | è¯»å–å±æ€§               | `proxy.name`             |
| `set`            | è®¾ç½®å±æ€§               | `proxy.name = 'Tom'`     |
| `has`            | åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨       | `'name' in proxy`        |
| `deleteProperty` | åˆ é™¤å±æ€§               | `delete proxy.name`      |
| `apply`          | è°ƒç”¨å‡½æ•°ï¼ˆå‡½æ•°ä»£ç†æ—¶ï¼‰ | `proxyFn()`              |
| `construct`      | ä½¿ç”¨ `new` åˆ›å»ºå®ä¾‹æ—¶  | `new proxyConstructor()` |

------

## âœ… ç¤ºä¾‹ 1ï¼šæ‹¦æˆªå¯¹è±¡å±æ€§è¯»å–å’Œå†™å…¥

```js
const user = { name: "Tom", age: 25 };

const proxyUser = new Proxy(user, {
  get(target, prop) {
    console.log("è¯»å–å±æ€§:", prop);
    return target[prop];
  },
  set(target, prop, value) {
    console.log("è®¾ç½®å±æ€§:", prop, "=", value);
    target[prop] = value;
    return true;
  }
});

proxyUser.name;          // æ§åˆ¶å°ï¼šè¯»å–å±æ€§: name
proxyUser.age = 30;      // æ§åˆ¶å°ï¼šè®¾ç½®å±æ€§: age = 30
```

------

## âœ… ç¤ºä¾‹ 2ï¼šæ•°ç»„ä¿æŠ¤

```js
const list = [1, 2, 3];

const safeList = new Proxy(list, {
  get(target, prop) {
    if (prop < 0 || prop >= target.length) {
      return undefined;
    }
    return target[prop];
  }
});

console.log(safeList[1]);  // 2
console.log(safeList[99]); // undefinedï¼Œè€Œä¸æ˜¯æŠ›é”™
```

------

## âœ… ç¤ºä¾‹ 3ï¼šå‡½æ•°é˜²æŠ–ï¼ˆå‡½æ•°ä»£ç† + applyï¼‰

```js
function search() {
  console.log("è¯·æ±‚æ¥å£:", Date.now());
}

const debouncedSearch = new Proxy(search, {
  apply(target, thisArg, args) {
    clearTimeout(target.timer);
    target.timer = setTimeout(() => target.apply(thisArg, args), 300);
  }
});

window.addEventListener("input", debouncedSearch);
```

------

## âœ… ç¤ºä¾‹ 4ï¼šæ„é€ å‡½æ•°ä»£ç†ï¼ˆæ‹¦æˆª newï¼‰

```js
class Person {
  constructor(name) {
    this.name = name;
  }
}

const PersonProxy = new Proxy(Person, {
  construct(target, args) {
    console.log("æ­£åœ¨åˆ›å»ºå®ä¾‹:", args);
    return new target(...args);
  }
});

const p = new PersonProxy("Alice"); // æ§åˆ¶å°ï¼šæ­£åœ¨åˆ›å»ºå®ä¾‹: ["Alice"]
```

------

## ğŸ¯ Proxy å¸¸è§ç”¨é€”æ€»ç»“

| ç”¨é€”            | ç¤ºä¾‹                                    |
| --------------- | --------------------------------------- |
| æ•°æ®ä¿æŠ¤        | æ‹¦æˆªéæ³•è®¿é—®æˆ–ä¿®æ”¹å±æ€§                  |
| æ—¥å¿—/ç›‘æ§       | è¯»å–å±æ€§æˆ–è°ƒç”¨å‡½æ•°æ—¶è®°å½•æ—¥å¿—            |
| æ¥å£é˜²æŠ–/èŠ‚æµ   | åŒ…è£…å‡½æ•°æ‰§è¡Œé€»è¾‘                        |
| ç»Ÿä¸€æ ¼å¼è½¬æ¢    | æ‹¦æˆªæ•°æ®è®¿é—®ï¼Œå®ç°å°é©¼å³°/ä¸‹åˆ’çº¿è‡ªåŠ¨è½¬æ¢ |
| è™šæ‹Ÿå±æ€§/æ‡’åŠ è½½ | åªæœ‰è®¿é—®åˆ°æŸå±æ€§æ—¶æ‰çœŸæ­£è®¡ç®—/åŠ è½½       |
| mock æ•°æ®ä»£ç†   | ç”¨äºæµ‹è¯•æˆ–å‰ç«¯ mock                     |

------

## ğŸ§  é¢è¯•å»ºè®®å›ç­”æ–¹å¼

> Proxy æ˜¯æˆ‘æ¯”è¾ƒå–œæ¬¢çš„ä¸€ä¸ªç‰¹æ€§ï¼Œåœ¨é¡¹ç›®ä¸­æˆ‘ç”¨å®ƒåšè¿‡æ¥å£ç¼“å­˜ã€è®¿é—®æ§åˆ¶ã€é˜²æŠ–åŒ…è£…ï¼Œè¿˜æ¨¡æ‹Ÿè¿‡å‰ç«¯ mock æ¥å£è¿”å›ã€‚å®ƒç›¸æ¯” Object.defineProperty æ›´çµæ´»ï¼Œæ”¯æŒå‡½æ•°ã€æ•°ç»„ã€æ„é€ å™¨ç­‰çš„æ‹¦æˆªã€‚

------

## âš ï¸ æ³¨æ„äº‹é¡¹

- `Proxy` æ˜¯**ä¸å¯ polyfill çš„**ï¼Œåªèƒ½åœ¨æ”¯æŒ ES6 çš„ç¯å¢ƒä½¿ç”¨ã€‚
- Proxy æ€§èƒ½å¼€é”€ç¨é«˜ï¼Œä¸å»ºè®®å¯¹å¤§é‡æ•°æ®é•¿é“¾å¼è®¿é—®åœºæ™¯ä½¿ç”¨ã€‚

# Reflect

> `Reflect` æ˜¯ ES6 å¼•å…¥çš„ä¸€ä¸ªå†…ç½®å¯¹è±¡ï¼Œæä¾›äº†**æ“ä½œå¯¹è±¡çš„ä½çº§æ–¹æ³•é›†åˆ**ï¼Œå’Œ `Object` ç±»ä¼¼ï¼Œä½†æ›´åå‘åº•å±‚è¡Œä¸ºæ§åˆ¶ã€‚

å®ƒçš„ç›®æ ‡æ˜¯ï¼š

- **ç»Ÿä¸€è¯­è¨€å†…éƒ¨æ–¹æ³•çš„è°ƒç”¨æ–¹å¼**
- **ä½œä¸º Proxy trap çš„é»˜è®¤å¤„ç†å‡½æ•°**
- **é¿å…ç ´ååŸå§‹è¡Œä¸ºæˆ–é‡å¤å®ç°åº•å±‚é€»è¾‘**

âœ… å¸¸ç”¨ API åŠè¯´æ˜

| Reflect æ–¹æ³•                       | ç­‰ä»·äº                                 | ç”¨é€”è¯´æ˜                   |
| ---------------------------------- | -------------------------------------- | :------------------------- |
| `Reflect.get(obj, key)`            | `obj[key]`                             | å®‰å…¨åœ°è¯»å–å±æ€§             |
| `Reflect.set(obj, key, val)`       | `obj[key] = val`                       | å®‰å…¨åœ°è®¾ç½®å±æ€§ï¼Œè¿”å›å¸ƒå°”å€¼ |
| `Reflect.has(obj, key)`            | `key in obj`                           | åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨           |
| `Reflect.deleteProperty(obj, key)` | `delete obj[key]`                      | åˆ é™¤å±æ€§                   |
| `Reflect.ownKeys(obj)`             | `Object.getOwnPropertyNames + Symbols` | è·å–æ‰€æœ‰é”®                 |
| `Reflect.defineProperty`           | ç±»ä¼¼ `Object.defineProperty`           | å®šä¹‰å±æ€§                   |
| `Reflect.construct()`              | æ„é€ å‡½æ•°æ‰§è¡Œ `new` è¡Œä¸º                | ç”¨äº Proxy æ„é€ å™¨æ‹¦æˆª      |
| `Reflect.apply()`                  | æ‰§è¡Œå‡½æ•°ï¼ˆç±»ä¼¼ `fn.apply`ï¼‰            | ç”¨äºå‡½æ•°è°ƒç”¨ä»£ç†           |

# Object.iså’Œ===ä»€ä¹ˆåŒºåˆ«

`Object.is` å’Œ `===`ï¼ˆä¸¥æ ¼ç›¸ç­‰ï¼‰åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹è¡¨ç°ä¸€è‡´ï¼Œä½†å®ƒä»¬åœ¨**å°‘æ•°è¾¹ç•Œæƒ…å†µ**æœ‰**æ˜¾è‘—ä¸åŒ**ã€‚

| æƒ…å†µ           | `===` ç»“æœ | `Object.is` ç»“æœ | è¯´æ˜                           |
| -------------- | ---------- | ---------------- | ------------------------------ |
| `+0` å’Œ `-0`   | `true`     | `false`          | `Object.is` åŒºåˆ† +0 å’Œ -0      |
| `NaN` å’Œ `NaN` | `false`    | `true`           | `Object.is` èƒ½åˆ¤æ–­ NaN === NaN |

# æµè§ˆå™¨çš„è¿›ç¨‹ä¸çº¿ç¨‹

æµè§ˆå™¨æ˜¯ä¸€ä¸ªå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹çš„å¤æ‚è½¯ä»¶ç³»ç»Ÿï¼Œä¸ºäº†æå‡**æ€§èƒ½ã€ç¨³å®šæ€§ã€å®‰å…¨æ€§**ï¼Œå®ƒæŠŠä¸åŒæ¨¡å—åˆ†æ•£åœ¨å¤šä¸ªè¿›ç¨‹å’Œçº¿ç¨‹ä¸­ã€‚æˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥è¯¦ç»†ä»‹ç»ï¼š

------

## ä¸€ã€æµè§ˆå™¨çš„ä¸»è¦**è¿›ç¨‹**

ç°ä»£æµè§ˆå™¨ï¼ˆå¦‚ Chromeï¼‰é‡‡ç”¨å¤šè¿›ç¨‹æ¶æ„ï¼Œä»¥ä¸‹æ˜¯ä¸»è¦çš„è¿›ç¨‹ç±»å‹ï¼š

| è¿›ç¨‹å                              | æè¿°                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| **æµè§ˆå™¨ä¸»è¿›ç¨‹ï¼ˆBrowser Processï¼‰** | å”¯ä¸€ä¸€ä¸ªï¼Œè´Ÿè´£åè°ƒã€ç•Œé¢ã€èµ„æºç®¡ç†ã€ç½‘ç»œè¯·æ±‚ã€é¡µé¢è°ƒåº¦ç­‰ã€‚ä¹Ÿç§°UIè¿›ç¨‹ã€‚ |
| **æ¸²æŸ“è¿›ç¨‹ï¼ˆRenderer Processï¼‰**    | æ¯ä¸ª Tab é¡µé¢ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œè´Ÿè´£ HTMLã€CSSã€JS çš„è§£æå’Œæ¸²æŸ“ã€‚   |
| **GPU è¿›ç¨‹**                        | è´Ÿè´£å›¾å½¢ç›¸å…³ä»»åŠ¡ï¼Œå¤„ç†åˆæˆå›¾å±‚ã€åŠ é€Ÿæ¸²æŸ“ã€‚                   |
| **ç½‘ç»œè¿›ç¨‹ï¼ˆNetwork Processï¼‰**     | ç‹¬ç«‹å‡ºæ¥è´Ÿè´£ç½‘ç»œè¯·æ±‚ã€ç¼“å­˜ã€Cookieã€HTTP ç­‰ã€‚                |
| **æ’ä»¶è¿›ç¨‹ï¼ˆå·²è¿‡æ—¶ï¼‰**              | è€ç‰ˆæœ¬ç”¨æ¥è¿è¡Œ Flash ç­‰æ’ä»¶ï¼Œç°åœ¨å·²åŸºæœ¬åºŸå¼ƒã€‚                |
| **æ‰©å±•è¿›ç¨‹**                        | è¿è¡Œæµè§ˆå™¨æ‰©å±•ç¨‹åºï¼Œå¦‚ Chrome æ’ä»¶ã€‚                         |

------

## äºŒã€æ¸²æŸ“è¿›ç¨‹å†…éƒ¨çš„ä¸»è¦çº¿ç¨‹

æ¯ä¸ª**æ¸²æŸ“è¿›ç¨‹**æœ¬èº«æ˜¯å¤šçº¿ç¨‹çš„ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®çº¿ç¨‹ï¼š

| çº¿ç¨‹                                         | èŒè´£                                                         |
| -------------------------------------------- | ------------------------------------------------------------ |
| **ä¸»çº¿ç¨‹ï¼ˆUI/Main Threadï¼‰**                 | æ‰§è¡Œ JSã€è§£æ HTML/CSSã€æ„å»º DOMã€å¤„ç†äº‹ä»¶å¾ªç¯ã€è°ƒåº¦ä»»åŠ¡ç­‰ã€‚æ˜¯ Web å¼€å‘ä¸­æœ€æ ¸å¿ƒçš„çº¿ç¨‹ã€‚ |
| **æ¸²æŸ“çº¿ç¨‹ï¼ˆåˆæˆçº¿ç¨‹ / Compositor Threadï¼‰** | è´Ÿè´£å›¾å±‚åˆæˆã€ç»˜åˆ¶å‰å‡†å¤‡ï¼Œç”¨äºé¡µé¢æ»šåŠ¨ã€åˆæˆåŠ¨ç”»ç­‰ï¼Œç‹¬ç«‹äºä¸»çº¿ç¨‹ã€‚ |
| **JS å¼•æ“çº¿ç¨‹ï¼ˆV8çº¿ç¨‹ï¼‰**                    | V8 JavaScript å¼•æ“åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œæ‰§è¡Œ JS è„šæœ¬ã€‚             |
| **æ ·å¼è®¡ç®—çº¿ç¨‹ / Layout Thread**             | å’Œä¸»çº¿ç¨‹é…åˆï¼Œè®¡ç®— CSSã€å¸ƒå±€ä½ç½®ç­‰ï¼Œé€šå¸¸æ˜¯ä¸»çº¿ç¨‹å¤„ç†ã€‚       |
| **å·¥ä½œçº¿ç¨‹ï¼ˆWeb Workerï¼‰**                   | JS å¯åˆ›å»ºçš„çº¿ç¨‹ï¼Œæ‰§è¡Œè€—æ—¶æ“ä½œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼ˆä½†ä¸èƒ½è®¿é—® DOMï¼‰ã€‚ |
| **å®šæ—¶å™¨çº¿ç¨‹ï¼ˆTimer Threadï¼‰**               | ç®¡ç† `setTimeout`ã€`setInterval` çš„å›è°ƒé˜Ÿåˆ—ä¸è§¦å‘ã€‚          |
| **äº‹ä»¶è§¦å‘çº¿ç¨‹**                             | æ¥è‡ªç½‘ç»œã€è¾“å…¥ã€ç”¨æˆ·æ“ä½œç­‰äº‹ä»¶ä»è¿™é‡Œè¿›å…¥ä¸»çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ã€‚   |
| **çº¿ç¨‹æ± ï¼ˆä¾‹å¦‚ Fetchã€Promiseã€Web APIsï¼‰**  | æµè§ˆå™¨å†…éƒ¨çº¿ç¨‹æ± å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œå¦‚ç½‘ç»œè¯·æ±‚ã€å¼‚æ­¥ I/Oã€‚         |

------

## ä¸‰ã€æ¸²æŸ“æµç¨‹ï¼šçº¿ç¨‹å‚ä¸å…³ç³»

é¡µé¢åŠ è½½å’Œæ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œå„ä¸ªçº¿ç¨‹åä½œå¦‚ä¸‹ï¼š

```plaintext
1. HTML/CSS è§£æï¼ˆä¸»çº¿ç¨‹ï¼‰
2. æ„å»º DOM/CSSOMï¼ˆä¸»çº¿ç¨‹ï¼‰
3. JS æ‰§è¡Œã€ä¿®æ”¹ DOMï¼ˆä¸»çº¿ç¨‹ / V8ï¼‰
4. æ ·å¼è®¡ç®—ã€å¸ƒå±€ï¼ˆä¸»çº¿ç¨‹ï¼‰
5. ç»˜åˆ¶å›¾å±‚ï¼ˆä¸»çº¿ç¨‹ï¼‰
6. å›¾å±‚åˆæˆï¼ˆåˆæˆçº¿ç¨‹ï¼‰
7. GPU åŠ é€Ÿç»˜åˆ¶ï¼ˆGPU è¿›ç¨‹ï¼‰
```

------

## å››ã€å¼‚æ­¥äº‹ä»¶å’Œçº¿ç¨‹å…³ç³»

æµè§ˆå™¨çš„å¼‚æ­¥æœºåˆ¶ï¼ˆEvent Loopï¼‰æ¶‰åŠå¤šä¸ªçº¿ç¨‹ï¼š

### 1. ä¸»çº¿ç¨‹ä¸­çš„ Event Loop

ä¸»çº¿ç¨‹é€šè¿‡äº‹ä»¶å¾ªç¯æœºåˆ¶ç®¡ç†æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ï¼š

- **å®ä»»åŠ¡ï¼ˆMacro Taskï¼‰**ï¼šå¦‚ `setTimeout`ã€`setInterval`ã€`requestAnimationFrame`ã€UI æ¸²æŸ“ã€äº‹ä»¶å›è°ƒã€‚
- **å¾®ä»»åŠ¡ï¼ˆMicro Taskï¼‰**ï¼šå¦‚ `Promise.then`ã€`MutationObserver`ã€queueMicrotaskã€‚

### 2. å…¶ä»–çº¿ç¨‹é…åˆ

| å¼‚æ­¥æœºåˆ¶                   | çº¿ç¨‹æ”¯æŒ                                      | è¯´æ˜                       |
| -------------------------- | --------------------------------------------- | -------------------------- |
| `setTimeout`/`setInterval` | **å®šæ—¶å™¨çº¿ç¨‹** è§¦å‘äº‹ä»¶å›è°ƒ -> ä¼ å…¥ä¸»çº¿ç¨‹æ‰§è¡Œ |                            |
| `fetch`ã€XHR               | **ç½‘ç»œçº¿ç¨‹** å‘èµ·è¯·æ±‚ï¼Œå®Œæˆåè§¦å‘äº‹ä»¶å›è°ƒ     |                            |
| `Web Worker`               | ç‹¬ç«‹çº¿ç¨‹                                      | ä¸èƒ½è®¿é—® DOMï¼Œé€‚åˆå¯†é›†è®¡ç®— |
| `requestIdleCallback`      | ä¸»çº¿ç¨‹ç©ºé—²æ—¶è°ƒåº¦æ‰§è¡Œ                          |                            |
| `requestAnimationFrame`    | åˆæˆçº¿ç¨‹ + ä¸»çº¿ç¨‹                             | ä¸‹æ¬¡é‡ç»˜å‰æ‰§è¡Œï¼Œç”¨äºåŠ¨ç”»   |

------

## äº”ã€æ€»ç»“å›¾ç¤ºï¼šè¿›ç¨‹ä¸çº¿ç¨‹å…³ç³»ï¼ˆç®€åŒ–ï¼‰

```
æµè§ˆå™¨è¿›ç¨‹ï¼ˆUIï¼‰
â”œâ”€â”€ è´Ÿè´£åœ°å€æ ã€ä¹¦ç­¾æ ã€å‰è¿›/åé€€ã€Tab ç®¡ç†
â”‚
â”œâ”€â”€ å¯åŠ¨æ¸²æŸ“è¿›ç¨‹ï¼ˆæ¯ä¸ªé¡µé¢ä¸€ä¸ªï¼‰
â”‚   â”œâ”€â”€ ä¸»çº¿ç¨‹ï¼ˆHTML/CSS/JS æ‰§è¡Œï¼‰
â”‚   â”œâ”€â”€ JS å¼•æ“çº¿ç¨‹ï¼ˆV8ï¼‰
â”‚   â”œâ”€â”€ äº‹ä»¶çº¿ç¨‹ï¼ˆç›‘å¬è¾“å…¥/é¼ æ ‡ï¼‰
â”‚   â”œâ”€â”€ åˆæˆçº¿ç¨‹ï¼ˆç»˜åˆ¶å›¾å±‚ï¼‰
â”‚   â”œâ”€â”€ Timer çº¿ç¨‹ï¼ˆå®šæ—¶å™¨ï¼‰
â”‚   â”œâ”€â”€ Workerçº¿ç¨‹ï¼ˆå¦‚ Web Workerï¼‰
â”‚
â”œâ”€â”€ ç½‘ç»œè¿›ç¨‹ï¼ˆç‹¬ç«‹ï¼‰
â”‚   â””â”€â”€ ç®¡ç† HTTP è¯·æ±‚ï¼Œç¼“å­˜ï¼ŒCookie
â”‚
â””â”€â”€ GPU è¿›ç¨‹ï¼ˆç‹¬ç«‹ï¼‰
    â””â”€â”€ å›¾å½¢ç»˜åˆ¶ã€ç¡¬ä»¶åŠ é€Ÿ
```

------

## å…­ã€é¢è¯•æ€»ç»“è®°å¿†å»ºè®®

- â€œä¸€ä¸ªä¸»è¿›ç¨‹ + å¤šä¸ªæ¸²æŸ“è¿›ç¨‹ + ç½‘ç»œ/GPUç­‰è¾…åŠ©è¿›ç¨‹â€ã€‚
- ä¸»çº¿ç¨‹è´Ÿè´£æ‰§è¡Œ JSã€æ„å»º DOMã€‚
- åˆæˆçº¿ç¨‹ã€GPU åˆ†æ‹… UI ç»˜åˆ¶å‹åŠ›ã€‚
- Web Worker å’Œä¸»çº¿ç¨‹é€šä¿¡ï¼Œç”¨äºå¹¶è¡Œè®¡ç®—ã€‚
- å®šæ—¶å™¨ã€ç½‘ç»œç­‰äº‹ä»¶ç”±åå°çº¿ç¨‹è§¦å‘ï¼Œ**é€šè¿‡äº‹ä»¶å¾ªç¯ä¼ å…¥ä¸»çº¿ç¨‹æ‰§è¡Œå›è°ƒ**ã€‚

## ä¸ƒã€ä¸»çº¿ç¨‹é‡ç‚¹

```css
ğŸ§  æ¸²æŸ“è¿›ç¨‹ï¼ˆRenderer Processï¼‰
â”œâ”€â”€ ğŸ‘¨â€ğŸ’» ä¸»çº¿ç¨‹ï¼ˆMain Threadï¼‰
â”‚   â”œâ”€â”€ ğŸ’¡ åŒ…å« V8 JavaScript å¼•æ“ï¼ˆJS æ‰§è¡Œï¼‰
â”‚   â”œâ”€â”€ ğŸ§± è´Ÿè´£ HTML/CSS è§£æï¼Œæ„å»º DOM/CSSOM
â”‚   â”œâ”€â”€ ğŸ§® è®¡ç®—æ ·å¼ã€å¸ƒå±€
â”‚   â”œâ”€â”€ ğŸ”„ äº‹ä»¶å¾ªç¯ã€å¤„ç†å›è°ƒ
â”‚
â”œâ”€â”€ ğŸ¨ åˆæˆçº¿ç¨‹ï¼ˆCompositor Threadï¼‰
â”‚   â””â”€â”€ åˆæˆå›¾å±‚ï¼Œå‡†å¤‡ GPU ç»˜åˆ¶
â”‚
â”œâ”€â”€ ğŸ“¦ Web Worker çº¿ç¨‹ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ ğŸ•’ å®šæ—¶å™¨çº¿ç¨‹ï¼ˆå¯é€‰ï¼‰
```

**ä¸»çº¿ç¨‹ = åŒ…å«äº† V8 JS å¼•æ“çš„ HTML æ¸²æŸ“è°ƒåº¦çº¿ç¨‹**

V8 JavaScript å¼•æ“çº¿ç¨‹ï¼ˆJS å¼•æ“çº¿ç¨‹ï¼‰:

- å®é™…ä¸Šå¹¶ä¸æ˜¯å•ç‹¬çš„çº¿ç¨‹ï¼Œè€Œæ˜¯**è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ JavaScript å¼•æ“**ã€‚
- Chrome ä½¿ç”¨ V8 å¼•æ“ï¼Œåœ¨ä¸»çº¿ç¨‹å†…æ‰§è¡Œ JS ä»£ç ã€‚
- æ‰€ä»¥ä½ çœ‹åˆ° JS è¿è¡Œæ…¢ã€é˜»å¡é¡µé¢ï¼Œå…¶å®å°±æ˜¯**ä¸»çº¿ç¨‹è¢« JS å ç”¨**ã€‚

# requestIdleCallbackæ˜¯ä»€ä¹ˆ

`requestIdleCallback` æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ª APIï¼Œç”¨äº **åœ¨æµè§ˆå™¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶æ‰§è¡Œéå…³é”®ä»»åŠ¡**ï¼Œä¸ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ã€‚å®ƒé€‚åˆå¤„ç†é‚£äº›**å¯å»¶è¿Ÿæ‰§è¡Œã€éç´§æ€¥çš„ä»»åŠ¡**ï¼Œæ¯”å¦‚é¢„åŠ è½½æ•°æ®ã€æ—¥å¿—ä¸ŠæŠ¥ã€æ‡’åˆå§‹åŒ–ç­‰ã€‚

------

### âœ… ä¸€å¥è¯ç†è§£

> `requestIdleCallback` è®©ä½ â€œç­‰æµè§ˆå™¨ç©ºäº†å†è¯´â€ï¼Œä¸ä¼šå½±å“ç”¨æˆ·äº¤äº’å’Œæ¸²æŸ“æ€§èƒ½ã€‚

------

### ğŸ“¦ åŸºæœ¬ç”¨æ³•

```js
requestIdleCallback((deadline) => {
  while (deadline.timeRemaining() > 0 && tasks.length > 0) {
    doSomeTask(tasks.shift());
  }
});
```

------

### å‚æ•°è§£é‡Š

å›è°ƒå‡½æ•°æ¥æ”¶ä¸€ä¸ª `IdleDeadline` å¯¹è±¡ï¼ŒåŒ…å«ï¼š

| å±æ€§/æ–¹æ³•         | è¯´æ˜                                          |
| ----------------- | --------------------------------------------- |
| `timeRemaining()` | è¿”å›å½“å‰ç©ºé—²æ—¶é—´çš„å‰©ä½™æ¯«ç§’æ•°ï¼ˆä¸€èˆ¬æœ€å¤š 50msï¼‰ |
| `didTimeout`      | å¦‚æœè®¾ç½®äº† `timeout` å¹¶è¶…æ—¶äº†ï¼Œåˆ™ä¸º `true`    |

------

### ğŸ§ª ç¤ºä¾‹ï¼šç©ºé—²æ—¶åŠ è½½å›¾ç‰‡

```js
requestIdleCallback((deadline) => {
  while (deadline.timeRemaining() > 0 && imageQueue.length > 0) {
    const img = new Image();
    img.src = imageQueue.shift();
    document.body.appendChild(img);
  }
});
```

------

### â± å¯é€‰å‚æ•°ï¼š`timeout`

```js
requestIdleCallback(callback, { timeout: 2000 });
```

> å¦‚æœåœ¨ 2 ç§’å†…å§‹ç»ˆæ²¡æœ‰ç©ºé—²æ—¶é—´ï¼Œå®ƒä¹Ÿä¼šå¼ºåˆ¶æ‰§è¡Œã€‚

------

### ğŸ” å¯¹æ¯” `setTimeout`

| ç‰¹ç‚¹             | `requestIdleCallback`  | `setTimeout`         |
| ---------------- | ---------------------- | -------------------- |
| è§¦å‘æ—¶æœº         | æµè§ˆå™¨ç©ºé—²æ—¶           | åˆ°æ—¶é—´ç«‹å³æ‰§è¡Œ       |
| æ˜¯å¦å½±å“æ¸²æŸ“     | âŒ å°½é‡ä¸å½±å“é¡µé¢æµç•…æ€§ | âœ… å¯èƒ½é˜»å¡æ¸²æŸ“æˆ–äº¤äº’ |
| æ˜¯å¦ä¿è¯æŒ‰æ—¶æ‰§è¡Œ | âŒ ä¸ä¿è¯               | âœ… å®šæ—¶åç«‹å³æ‰§è¡Œ     |

------

### âš ï¸ æµè§ˆå™¨å…¼å®¹æ€§

- æ”¯æŒåº¦ï¼šä»…ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Edge æ”¯æŒï¼Œ**Safari ä¸æ”¯æŒ**ï¼Œéƒ¨åˆ† Firefox æ”¯æŒï¼‰
- å¯ä»¥ç”¨ polyfill æ›¿ä»£ï¼š

```js
window.requestIdleCallback = window.requestIdleCallback || function (cb) {
  return setTimeout(() => {
    const start = Date.now();
    cb({
      didTimeout: false,
      timeRemaining: () => Math.max(0, 50 - (Date.now() - start))
    });
  }, 1);
};
```

------

### ğŸ”§ å®é™…åº”ç”¨åœºæ™¯

- âœ… æ‡’åŠ è½½éé¦–å±å›¾ç‰‡
- âœ… é¦–å±æ¸²æŸ“åä¸ŠæŠ¥æ—¥å¿—æˆ–æ‰“ç‚¹
- âœ… ä½ä¼˜å…ˆçº§çš„ç¼“å­˜é¢„çƒ­
- âœ… å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åˆå§‹åŒ–å¤§é‡æŒ‰é’®æˆ–æ¨¡å—
