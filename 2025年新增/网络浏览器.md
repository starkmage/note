# HTTPã€WebSocketã€SSEï¼ˆServer-Sent Eventsï¼‰

------

âœ… æ€»è§ˆå¯¹æ¯”è¡¨

| å¯¹æ¯”é¡¹               | **HTTP** (å¦‚ REST)            | **WebSocket**                    | **SSE (Server-Sent Events)**            |
| -------------------- | ----------------------------- | -------------------------------- | --------------------------------------- |
| **é€šä¿¡æ–¹å¼**         | è¯·æ±‚-å“åº”ï¼ˆå®¢æˆ·ç«¯å‘èµ·ï¼‰       | å…¨åŒå·¥ï¼ˆåŒå‘ï¼‰                   | å•å‘æ¨é€ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰             |
| **è¿æ¥çŠ¶æ€**         | çŸ­è¿æ¥ï¼ˆæˆ–é•¿è¿æ¥ keep-aliveï¼‰ | é•¿è¿æ¥                           | é•¿è¿æ¥                                  |
| **æ˜¯å¦æ”¯æŒå®æ—¶é€šä¿¡** | âŒ éœ€è½®è¯¢                      | âœ… å®æ—¶ï¼Œä½å»¶è¿Ÿ                   | âœ… å®æ—¶ï¼Œä½†åªèƒ½æœåŠ¡å™¨æ¨é€                |
| **è¿æ¥å»ºç«‹æ–¹å¼**     | ç›´æ¥è¯·æ±‚ï¼ˆHTTPï¼‰              | å…ˆ HTTP æ¡æ‰‹ï¼Œå‡çº§ä¸º WebSocket   | HTTP è¯·æ±‚å¤´ `Accept: text/event-stream` |
| **åè®®æ”¯æŒæ–¹å‘**     | å•å‘ï¼šå®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯         | åŒå‘ï¼šå®¢æˆ·ç«¯ â†” æœåŠ¡ç«¯            | å•å‘ï¼šæœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯                   |
| **æµè§ˆå™¨å…¼å®¹æ€§**     | âœ… å…¨é¢æ”¯æŒ                    | âœ… å…¨é¢æ”¯æŒï¼ˆIE10+ï¼‰              | âœ… ä¸»æµæ”¯æŒï¼ˆä¸æ”¯æŒ IEï¼‰                 |
| **ä¼ è¾“æ ¼å¼**         | æ–‡æœ¬ï¼ˆJSONã€HTML ç­‰ï¼‰         | æ–‡æœ¬æˆ–äºŒè¿›åˆ¶ï¼ˆå¦‚ protobufï¼‰      | çº¯æ–‡æœ¬ï¼Œæ ¼å¼å›ºå®š                        |
| **æ–­çº¿é‡è¿**         | æ‰‹åŠ¨å¤„ç†                      | éœ€è‡ªå·±å®ç°                       | âœ… å†…å»ºè‡ªåŠ¨é‡è¿æœºåˆ¶                      |
| **æœåŠ¡å™¨æ¨é€æ”¯æŒ**   | âŒ ä¸æ”¯æŒï¼ˆé™¤éè½®è¯¢ï¼‰          | âœ… æ”¯æŒ                           | âœ… æ”¯æŒ                                  |
| **èµ„æºæ¶ˆè€—**         | ç›¸å¯¹ä½ï¼ˆçŸ­è¿æ¥ï¼‰              | ä¸­ç­‰ï¼ˆä¿æŒé•¿è¿æ¥ï¼‰               | è¾ƒä½ï¼ˆåŸºäº HTTP é•¿è¿æ¥ï¼‰                |
| **ä½¿ç”¨åœºæ™¯**         | è¡¨å•æäº¤ã€API è°ƒç”¨ã€é¡µé¢åŠ è½½  | èŠå¤©ã€æ¸¸æˆã€åä½œç¼–è¾‘ã€è‚¡ç¥¨è¡Œæƒ…ç­‰ | é€šçŸ¥æ¨é€ã€è¿›åº¦æ›´æ–°ã€äº‹ä»¶æµï¼ˆå¦‚æ—¥å¿—ï¼‰    |

------

âœ… åœºæ™¯å»ºè®®

| éœ€æ±‚åœºæ™¯                | æ¨èåè®®      | åŸå› è¯´æ˜                     |
| ----------------------- | ------------- | ---------------------------- |
| æ™®é€š API è¯·æ±‚ã€è¡¨å•æäº¤ | **HTTP**      | ç®€å•ã€é€šç”¨                   |
| å®æ—¶èŠå¤© / ååŒç¼–è¾‘     | **WebSocket** | æ”¯æŒåŒå‘é€šä¿¡ï¼Œä½å»¶è¿Ÿ         |
| åå°æ¨é€é€šçŸ¥ / è¿›åº¦æ¡   | **SSE**       | ç®€å•è½»é‡ï¼Œæµè§ˆå™¨æ”¯æŒè‡ªåŠ¨é‡è¿ |

|   **æ–¹æ¡ˆ**    | **èµ„æºå ç”¨** | **å®æ—¶æ€§** | **å®ç°å¤æ‚åº¦** |       **é€‚ç”¨åœºæ™¯**       |
| :-----------: | :----------: | :--------: | :------------: | :----------------------: |
|    **SSE**    |  ä½ï¼ˆHTTPï¼‰  |     é«˜     |      ç®€å•      | æœåŠ¡å™¨æ¨é€ï¼ˆå¦‚ AI å›ç­”ï¼‰ |
| **WebSocket** |  é«˜ï¼ˆåŒå·¥ï¼‰  |    æœ€é«˜    |      å¤æ‚      |  åŒå‘äº¤äº’ï¼ˆå¦‚åœ¨çº¿æ¸¸æˆï¼‰  |
|   **è½®è¯¢**    |  é«˜ï¼ˆé¢‘ç¹ï¼‰  |     ä½     |      ç®€å•      |        å…¼å®¹æ€§å…œåº•        |

------

ğŸ“Œ ä¸¾ä¾‹è¯´æ˜

ğŸ”¹ HTTPï¼ˆRESTï¼‰ç¤ºä¾‹

```js
fetch('/api/user')
  .then(res => res.json())
  .then(data => console.log(data))
```

ğŸ”¹ WebSocket ç¤ºä¾‹

```js
const socket = new WebSocket('ws://example.com')
socket.onmessage = (event) => console.log('Message:', event.data)
socket.send('Hello from client')
```

ğŸ”¹ SSE ç¤ºä¾‹

```js
const evtSource = new EventSource('/events')
evtSource.onmessage = (e) => console.log('SSE:', e.data)
```

------

âœ… æ ¸å¿ƒå·®å¼‚æ€»ç»“ä¸€å¥è¯

| åè®®          | æ ¸å¿ƒä¸€å¥è¯æè¿°                                   |
| ------------- | ------------------------------------------------ |
| **HTTP**      | å®¢æˆ·ç«¯ä¸»åŠ¨è¯·æ±‚ï¼ŒæœåŠ¡ç«¯è¢«åŠ¨å“åº”ï¼Œé€‚åˆä¼ ç»Ÿ API     |
| **WebSocket** | åŒå‘é•¿è¿æ¥ï¼Œå®æ—¶åŒå‘é€šä¿¡ï¼Œé€‚åˆé«˜äº’åŠ¨å®æ—¶åœºæ™¯     |
| **SSE**       | æœåŠ¡ç«¯å•å‘æ¨é€ï¼Œè½»é‡å®æ—¶ä¼ è¾“ï¼Œé€‚åˆé€šçŸ¥æˆ–è¿›åº¦æ›´æ–° |

------

ğŸ§  é¢è¯•é‡ç‚¹æç¤º

- WebSocket æ˜¯åŒå‘é€šä¿¡ï¼Œ**ä½†ä¸é€‚åˆå¤§é‡è¿æ¥çš„åœºæ™¯**ï¼ˆå¦‚ç›´æ’­å¹³å°ï¼‰ï¼Œéœ€è¦é…åˆè¿æ¥æ± ã€å¿ƒè·³æ£€æµ‹ã€‚
- SSE **å¤©ç„¶æ”¯æŒé‡è¿å’Œäº‹ä»¶ ID ç®¡ç†**ï¼Œä½†ä¸æ”¯æŒäºŒè¿›åˆ¶ã€‚
- HTTP éœ€è¦è½®è¯¢æ¨¡æ‹Ÿå®æ—¶ï¼Œ**å®¹æ˜“æµªè´¹å¸¦å®½å’Œèµ„æº**ï¼Œä¸æ¨èç”¨äºé¢‘ç¹å˜åŠ¨æ•°æ®ã€‚

# ä¸ºä»€ä¹ˆ WebSocket è¦å…ˆè¿›è¡Œ HTTP æ¡æ‰‹ï¼Ÿ

å› ä¸º WebSocket è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†ï¼š

1. **å…¼å®¹ç°æœ‰çš„ HTTP åŸºç¡€è®¾æ–½**ï¼ˆå¦‚ç«¯å£ 80/443ã€é˜²ç«å¢™ã€ä»£ç†ç­‰ï¼‰
2. èƒ½åœ¨ HTTP åè®®ä¸­â€œå‡çº§â€è¿æ¥ï¼Œå®ç°æ›´é«˜æ•ˆçš„**å…¨åŒå·¥é€šä¿¡**

------

ğŸ§© æ¡æ‰‹è¿‡ç¨‹è¯¦è§£

å½“å®¢æˆ·ç«¯ä½¿ç”¨ `new WebSocket(url)` è¿æ¥æœåŠ¡å™¨æ—¶ï¼š

**1. æµè§ˆå™¨å‘èµ· HTTP è¯·æ±‚ï¼ˆå¸¦æœ‰ `Upgrade: websocket` å¤´ï¼‰ï¼š**

```
GET /chat HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
```

- è¿™æ˜¯ä¸€ä¸ª**æ ‡å‡†çš„ HTTP è¯·æ±‚**ï¼Œè¯·æ±‚æœåŠ¡å™¨å°†åè®®å‡çº§ä¸º WebSocketã€‚

------

**2. æœåŠ¡å™¨å“åº” HTTP 101ï¼ˆåˆ‡æ¢åè®®ï¼‰ï¼š**

```
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
```

- çŠ¶æ€ç  `101 Switching Protocols` è¡¨ç¤ºåè®®å·²å‡çº§ã€‚
- ä¹‹åï¼Œè¿æ¥è½¬ä¸º WebSocket é€šä¿¡ï¼Œå¼€å§‹**åŒå‘æ•°æ®ä¼ è¾“**ã€‚

------

ğŸ” é¢è¯•é‡ç‚¹æˆ–ç¬”è¯•å¯èƒ½é—®ï¼š

â“ WebSocket æ˜¯åŸºäº TCP è¿˜æ˜¯ HTTPï¼Ÿ

- âœ… ç­”æ¡ˆï¼š**å»ºç«‹é˜¶æ®µåŸºäº HTTPï¼Œé€šä¿¡é˜¶æ®µåŸºäº TCP**

------

âœ… æ€»ç»“ä¸€å¥è¯

> **WebSocket è¿æ¥å¿…é¡»é€šè¿‡ä¸€æ¬¡ HTTP æ¡æ‰‹è¯·æ±‚ï¼ˆUpgradeï¼‰ï¼ŒæœåŠ¡ç«¯å“åº” 101 åï¼Œæ‰çœŸæ­£è¿›å…¥ WebSocket é€šä¿¡é˜¶æ®µã€‚**

# ä¸ºä»€ä¹ˆ WebSocket å’Œ HTTP/2 å…¼å®¹æ€§ä¸å¥½ï¼Ÿ

1. **åè®®å‡çº§æ–¹å¼ä¸åŒï¼š**
    WebSocket æ˜¯é€šè¿‡ HTTP/1.1 çš„ `Upgrade: websocket` å¤´éƒ¨è¿›è¡Œæ¡æ‰‹å‡çº§çš„ï¼Œè¿™ç§ upgrade æœºåˆ¶åœ¨ HTTP/2 ä¸­ä¸å†å­˜åœ¨ï¼ˆæˆ–å®ç°å¤æ‚ï¼‰ï¼Œå› ä¸º HTTP/2 æ˜¯åŸºäºæµçš„å¤šè·¯å¤ç”¨åè®®ï¼Œæ²¡æœ‰ç±»ä¼¼ Upgrade çš„æœºåˆ¶ã€‚
2. **HTTP/2 ä¸å…è®¸ä¼ ç»Ÿçš„ upgradeï¼š**
    HTTP/2 çš„è®¾è®¡ç›®çš„å°±æ˜¯åœ¨ä¸€ä¸ªè¿æ¥ä¸Šå¤šè·¯å¤ç”¨å¤šä¸ªæµï¼Œä¸å†åƒ HTTP/1.1 é‚£æ ·ä¿æŒé•¿è¿æ¥å’Œå‡çº§åè®®ã€‚

------

âœ… **å¦‚æœä¸€å®šè¦åœ¨ HTTP/2 ä¸Šä¼ è¾“ WebSocketï¼Œæ€ä¹ˆåŠï¼Ÿ**

**RFC 8441** æä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œå«åšï¼š

> "Bootstrapping WebSockets with HTTP/2"

è¿™å…è®¸åœ¨ HTTP/2 çš„æŸä¸ª stream ä¸Šï¼Œä½¿ç”¨ `:protocol` pseudo-header æ¥åå•†å‡çº§ä¸º WebSocketã€‚ä½†æœ‰å‰ææ¡ä»¶ï¼š

- **å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¿…é¡»éƒ½æ”¯æŒ RFC 8441**
- å¸¸è§æ”¯æŒæ–¹ï¼š
  - æµè§ˆå™¨ï¼šä¸»æµæµè§ˆå™¨å¤§å¤šæ•° **å°šæœªå®Œå…¨æ”¯æŒ**
  - æœåŠ¡ç«¯ï¼šå¦‚ Envoyã€nghttp2 æœ‰ä¸€å®šæ”¯æŒï¼Œä½†ä¹Ÿè¦é…ç½®

# ä½¿ç”¨websocketæœ‰å“ªäº›ç¼ºé™·

1. **ä¸æ”¯æŒä¸­é—´ç¼“å­˜ã€CDN åŠ é€Ÿ**

- WebSocket æ˜¯é•¿è¿æ¥ï¼Œ**ä¸èµ°ä¼ ç»Ÿçš„ HTTP è¯·æ±‚-å“åº”æ¨¡å‹**ï¼Œå› æ­¤æ— æ³•é€šè¿‡ CDNã€åå‘ä»£ç†è¿›è¡Œç¼“å­˜ã€‚
- **ç¼ºç‚¹å½±å“ï¼š**
  - å¢åŠ æœåŠ¡å™¨è´Ÿæ‹…ï¼ˆæ‰€æœ‰è¯·æ±‚éƒ½è¦ç›´è¿æºæœåŠ¡å™¨ï¼‰
  - æ— æ³•åˆ©ç”¨è¾¹ç¼˜ç½‘ç»œä¼˜åŒ–æ€§èƒ½

------

2. **èµ„æºå ç”¨é«˜ï¼ˆè¿æ¥æ•°ï¼‰**

- WebSocket æ¯ä¸ªå®¢æˆ·ç«¯éƒ½ä¿æŒä¸€ä¸ªé•¿è¿æ¥ï¼ˆTCP + å†…å­˜å ç”¨ï¼‰ã€‚
- **é—®é¢˜ï¼š**
  - å¤§é‡è¿æ¥ä¼šæ‹–å®æœåŠ¡å™¨ï¼ˆå°¤å…¶æ˜¯ Node.js è¿™ç±»å•çº¿ç¨‹æ¶æ„ï¼‰
  - é€šå¸¸è¦ç”¨ä¸“é—¨çš„è¿æ¥ç½‘å…³ï¼ˆå¦‚ Nginxã€Envoy æˆ–è‡ªå»ºç½‘å…³ï¼‰åšè¿æ¥ç®¡ç†

------

3. **å¯¹ä»£ç†å’Œé˜²ç«å¢™ä¸å‹å¥½**

- ä¸€äº›ä¼ä¸šç½‘ç»œæˆ–æ—§çš„ä¸­é—´è®¾å¤‡ä¼šé˜»æ­¢éæ ‡å‡†çš„ `Upgrade: websocket` æ¡æ‰‹ã€‚
- **ç¼ºç‚¹å½±å“ï¼š**
  - æ— æ³•ç©¿é€æŸäº›ä¼ä¸šé˜²ç«å¢™ã€è€æ—§ä»£ç†æœåŠ¡å™¨
  - ç½‘ç»œå…¼å®¹æ€§å·®äº HTTP è½®è¯¢æˆ– SSEï¼ˆServer-Sent Eventsï¼‰

------

4. **åè®®å±‚å®‰å…¨æ§åˆ¶è¾ƒå¼±**

- WebSocket ä¸åƒ HTTP é‚£æ ·å¤©ç„¶æ”¯æŒç»†ç²’åº¦çš„æƒé™æ§åˆ¶ï¼ˆå¦‚åŸºäº header çš„èº«ä»½éªŒè¯ã€æƒé™è·¯ç”±ç­‰ï¼‰ã€‚
- **éœ€è¦è‡ªå·±å®ç°ï¼š**
  - å¿ƒè·³æ£€æµ‹
  - é‡è¿é€»è¾‘
  - èº«ä»½æ ¡éªŒã€token ç»­ç­¾

------

5. **å’Œ HTTP/2/3 ä¸å…¼å®¹**

- ä¹‹å‰æåˆ°è¿‡ï¼ŒWebSocket æ— æ³•åŸç”Ÿåœ¨ HTTP/2 å¤šè·¯å¤ç”¨ä¸Šè¿è¡Œï¼Œä¸æ”¯æŒå¤šä¸ªè¿æ¥å…±äº«ä¸€ä¸ª TCP é€šé“ã€‚
- éš¾ä»¥ä¸æ–°ä¸€ä»£åè®®ï¼ˆHTTP/2ã€HTTP/3ï¼‰èåˆ

------

6. **ä¸é€‚åˆæœåŠ¡ç«¯æ¨é€å¹¿æ’­ï¼ˆPub/Subï¼‰åœºæ™¯**

- WebSocket æ˜¯ç‚¹å¯¹ç‚¹é€šä¿¡ã€‚è¦å®ç°**å¹¿æ’­**æˆ–**å¤šè®¢é˜…è€…**æœºåˆ¶ï¼Œéœ€è¦åç«¯ç»´æŠ¤æ˜ å°„å…³ç³»æˆ–æ¥å…¥ Pub/Sub ç³»ç»Ÿã€‚
- å®ç°å¤æ‚åº¦ â†‘

------

7. **ç¼ºä¹æ ‡å‡†åŒ–çš„ API ä¸è°ƒè¯•å·¥å…·**

- ä¸ä¼ ç»Ÿ REST API ä¸åŒï¼ŒWebSocket æŠ¥æ–‡æ˜¯è‡ªå®šä¹‰çš„äºŒè¿›åˆ¶/æ–‡æœ¬åè®®ï¼Œè°ƒè¯•å’Œæ–‡æ¡£ç”Ÿæˆéƒ½æ¯”è¾ƒå›°éš¾ã€‚
- API è§„èŒƒï¼ˆå¦‚ RESTfulã€OpenAPIï¼‰æ— æ³•å¤ç”¨

------

8. **ä¸èƒ½å¤©ç„¶é™çº§**

- å¦‚æœ WebSocket æ¡æ‰‹å¤±è´¥ï¼Œæµè§ˆå™¨é»˜è®¤ä¸ä¼šè‡ªåŠ¨å›é€€åˆ° HTTP Pollingï¼Œéœ€è¦å‰ç«¯ä»£ç æ‰‹åŠ¨å®ç° fallbackï¼ˆå¤æ‚ï¼‰

# sseå’Œhttpçš„streamä¼ è¾“æœ‰ä»€ä¹ˆåŒºåˆ«

SSE çš„åŸç†æ˜¯ï¼š

- æµè§ˆå™¨ä½¿ç”¨ `EventSource` å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚ï¼›
- æœåŠ¡å™¨è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ `text/event-stream` å“åº”ï¼›
- ç„¶åæœåŠ¡å™¨å¯ä»¥ä¸€ç›´é€šè¿‡è¿™ä¸ªè¿æ¥å‘é€æ•°æ®ï¼›
- ä½† **æµè§ˆå™¨æ— æ³•é€šè¿‡è¿™ä¸ªè¿æ¥å‘æ•°æ®å›å»**ï¼Œéœ€è¦é¢å¤–å‘ Ajax / Fetch è¯·æ±‚ã€‚

**SSEï¼ˆServer-Sent Eventsï¼‰** å’Œ **HTTP streamingï¼ˆHTTP é•¿æµ / æµå¼å“åº”ï¼‰** åœ¨æœ¬è´¨ä¸Šéƒ½ä½¿ç”¨ HTTP é•¿è¿æ¥å®ç°**æŒç»­ä¼ è¾“æ•°æ®**ï¼Œä½†ä¸¤è€…åœ¨**åè®®è§„èŒƒã€ç”¨é€”ã€æµè§ˆå™¨æ”¯æŒã€æ ¼å¼å’Œå°è£…å±‚çº§**ä¸Šæœ‰å…³é”®åŒºåˆ«ã€‚

------

âœ… æ ¸å¿ƒåŒºåˆ«æ€»ç»“è¡¨

| å¯¹æ¯”é¡¹           | **SSEï¼ˆServer-Sent Eventsï¼‰**   | **HTTP Streamï¼ˆæµå¼å“åº”ï¼‰**         |
| ---------------- | ------------------------------- | ----------------------------------- |
| **åè®®è§„èŒƒ**     | æœ‰æ ‡å‡†åè®®ï¼ˆHTML5 å®šä¹‰ï¼‰        | æ— ç»Ÿä¸€æ ‡å‡†ï¼ˆåŸºäº HTTP å“åº”å®ç°ï¼‰    |
| **å®¢æˆ·ç«¯æ”¯æŒ**   | æµè§ˆå™¨å†…å»ºæ”¯æŒï¼ˆEventSourceï¼‰   | éœ€æ‰‹åŠ¨å¤„ç†ï¼ˆfetch/XHRï¼‰æˆ–è‡ªå®šä¹‰é€»è¾‘ |
| **è¿æ¥æ–¹å¼**     | ä½¿ç”¨ `text/event-stream` å“åº”å¤´ | æ™®é€š HTTP å“åº”ï¼ŒæŒç»­ä¸å…³é—­è¿æ¥      |
| **é€šä¿¡æ–¹å‘**     | å•å‘ï¼šæœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯           | å•å‘ï¼šæœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯               |
| **æ ¼å¼çº¦å®š**     | æ˜ç¡®è§„å®šå­—æ®µï¼ˆdata:\n\nï¼‰       | æ— æ ¼å¼é™åˆ¶ï¼Œè‡ªå®šä¹‰ chunk            |
| **è‡ªåŠ¨é‡è¿æœºåˆ¶** | âœ… æœ‰å†…å»ºæ”¯æŒï¼ˆè‡ªåŠ¨é‡è¿ï¼‰        | âŒ éœ€è¦å¼€å‘è€…è‡ªè¡Œå¤„ç†                |
| **äº‹ä»¶åˆ†å‘æœºåˆ¶** | âœ… æ”¯æŒ `event`, `id` å­—æ®µç­‰     | âŒ ä¸æ”¯æŒï¼Œéœ€è¦æ‰‹åŠ¨è§£æ              |
| **æ–­ç‚¹ç»­ä¼ æ”¯æŒ** | âœ… æ”¯æŒï¼ˆLast-Event-IDï¼‰         | âŒ ä¸æ”¯æŒ                            |
| **ç¼–ç è¦æ±‚**     | UTF-8 å¼ºåˆ¶ç¼–ç                   | ä»»æ„æ ¼å¼ï¼ˆJSONã€äºŒè¿›åˆ¶ã€çº¯æ–‡æœ¬ï¼‰    |
| **ä½¿ç”¨åœºæ™¯**     | è½»é‡æ¨é€ï¼šé€šçŸ¥ã€è¿›åº¦ã€æ—¥å¿—æµç­‰  | è§†é¢‘æµã€æ—¥å¿—ã€Chatã€AI æµè¾“å‡ºç­‰     |

------

ğŸ” è¿›ä¸€æ­¥è§£é‡Š

1. ğŸ“¦ **SSE æ˜¯æ ‡å‡†åè®®ï¼ˆtext/event-streamï¼‰**

- æµè§ˆå™¨å†…å»º `EventSource` æ¥å£ï¼š

  ```js
  const es = new EventSource('/events')
  es.onmessage = (e) => console.log('msg:', e.data)
  ```

- æœåŠ¡ç«¯å“åº”æ ¼å¼è§„èŒƒï¼š

  ```
  data: hello
  id: 123
  event: message
  
  data: another line
  ```

SSE è‡ªåŠ¨æ”¯æŒï¼š

- æ–­çº¿é‡è¿ï¼ˆå¸¦ä¸Š `Last-Event-ID`ï¼‰
- åˆ†ç‰‡å‘é€ï¼ˆå¤šæ¡æ¶ˆæ¯ï¼‰
- äº‹ä»¶ç±»å‹

------

2. ğŸ” **HTTP streaming æ˜¯ä¼ è¾“æ¨¡å¼ï¼Œä¸æ˜¯åè®®**

- å®¢æˆ·ç«¯ä½¿ç”¨ `fetch` æˆ– `XHR` å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¿æŒè¿æ¥ï¼Œ**ä¸æ–­å†™å…¥å“åº”æµ**ã€‚

ç¤ºä¾‹ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼š

```js
const response = await fetch('/stream')
const reader = response.body.getReader()
```

ç¤ºä¾‹ï¼ˆæœåŠ¡ç«¯ï¼‰ï¼š

```js
res.write('chunk 1\n')
setTimeout(() => res.write('chunk 2\n'), 1000)
```

- æ²¡æœ‰æ ¼å¼é™åˆ¶ï¼Œå‰ç«¯éœ€è¦æ‰‹åŠ¨æ‹†åˆ†è§£æ
- æ²¡æœ‰â€œäº‹ä»¶â€æ¦‚å¿µï¼Œä¹Ÿæ— è‡ªåŠ¨æ–­ç‚¹ç»­ä¼ 

------

ğŸ“Œ åº”ç”¨åœºæ™¯æ¯”è¾ƒ

| åœºæ™¯                           | æ¨èåè®®             | åŸå›                                |
| ------------------------------ | -------------------- | ---------------------------------- |
| é€šçŸ¥æ¨é€ / è¿›åº¦æ¡ / ç®€å•äº‹ä»¶æµ | âœ… SSE                | æµè§ˆå™¨æ”¯æŒï¼Œè½»é‡ï¼Œè‡ªåŠ¨é‡è¿         |
| ChatGPT æµå¼å“åº” / AI ç”Ÿæˆæµ   | âœ… HTTP stream        | éœ€è¦æµå¼æ§åˆ¶æ–‡æœ¬è¾“å‡ºï¼Œæ²¡æœ‰æ ¼å¼é™åˆ¶ |
| è§†é¢‘/éŸ³é¢‘æµ                    | âœ… HTTP stream æˆ– HLS | æ›´çµæ´»çš„äºŒè¿›åˆ¶æ”¯æŒ                 |
| éœ€å‘é€å¤šç±»å‹äº‹ä»¶ã€é‡è¿         | âœ… SSE                | è‡ªå¸¦äº‹ä»¶å’Œ ID æ”¯æŒ                 |

------

âœ… æ€»ç»“ä¸€å¥è¯ï¼š

> **SSE æ˜¯ä¸“ä¸ºæœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€äº‹ä»¶è€Œè®¾è®¡çš„ HTTP åè®®æ‰©å±•ï¼Œæœ‰æ ¼å¼ã€æœ‰æ ‡å‡†ã€æµè§ˆå™¨æ”¯æŒå¥½ï¼›è€Œ HTTP streaming æ˜¯ä¸€ç§åŸå§‹çš„â€œä¸æ–­å†™å…¥å“åº”â€çš„æ¨¡å¼ï¼Œæ›´è‡ªç”±ä½†æ›´åº•å±‚ã€‚

# SSEçš„ç¼ºé™·

------

**1. å•å‘é€šä¿¡ï¼ˆä»… Server â†’ Clientï¼‰**

- **é—®é¢˜**ï¼šSSE åªæ”¯æŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œ**å®¢æˆ·ç«¯æ— æ³•é€šè¿‡åŒä¸€è¿æ¥å‘é€æ•°æ®**ã€‚

------

**2. åŸºäº HTTP/1.1 çš„æ½œåœ¨æ€§èƒ½é—®é¢˜**

- **é˜Ÿå¤´é˜»å¡ï¼ˆHead-of-Line Blockingï¼‰**ï¼š
  åœ¨ HTTP/1.1 ä¸‹ï¼Œæµè§ˆå™¨å¯¹åŒä¸€åŸŸåçš„å¹¶å‘è¿æ¥æ•°æœ‰é™ï¼ˆé€šå¸¸ 6 ä¸ªï¼‰ï¼Œå¦‚æœåŒæ—¶ä½¿ç”¨å¤šä¸ª SSE è¿æ¥ï¼Œå¯èƒ½è¢«é˜»å¡ã€‚
- **HTTP/2 ç¼“è§£ä½†éå®Œå…¨è§£å†³**ï¼š
  HTTP/2 çš„å¤šè·¯å¤ç”¨å¯ä»¥æ”¹å–„æ­¤é—®é¢˜ï¼Œä½†æŸäº›ä»£ç†æˆ–æ—§æœåŠ¡å¯èƒ½ä»ä¸æ”¯æŒ HTTP/2 ä¸‹çš„é•¿è¿æ¥ã€‚

| **ç‰¹æ€§** |     **HTTP/1.1 + SSE**      |      **HTTP/2 + SSE**       |
| :------: | :-------------------------: | :-------------------------: |
|  è¿æ¥æ•°  | æ¯ä¸ª SSE å ç”¨ 1 ä¸ª TCP è¿æ¥ | æ‰€æœ‰ SSE å¤ç”¨ 1 ä¸ª TCP è¿æ¥ |
| é˜Ÿå¤´é˜»å¡ | æ˜¯ï¼ˆåŒä¸€åŸŸå 6~8 è¿æ¥é™åˆ¶ï¼‰ |       å¦ï¼ˆå¤šè·¯å¤ç”¨ï¼‰        |
| å¤´éƒ¨å¼€é”€ | é«˜ï¼ˆæ¯æ¬¡è¿æ¥é‡å¤å‘é€å¤´éƒ¨ï¼‰  |      ä½ï¼ˆHPACK å‹ç¼©ï¼‰       |
| é€‚ç”¨åœºæ™¯ |         ä½å¹¶å‘åœºæ™¯          |       é«˜å¹¶å‘å®æ—¶æ¨é€        |

------

**3. åè®®é™åˆ¶**

- **æ–‡æœ¬åè®®**ï¼šSSE ä»…æ”¯æŒ UTF-8 æ–‡æœ¬æ•°æ®ï¼Œ**ä¸æ”¯æŒäºŒè¿›åˆ¶æ•°æ®**ï¼ˆå¦‚æ–‡ä»¶ä¼ è¾“ï¼‰ã€‚
- **è½»é‡ä½†åŠŸèƒ½ç®€å•**ï¼š
  æ¶ˆæ¯æ ¼å¼ä¸º `data: ...\n\n`ï¼Œç¼ºä¹é«˜çº§ç‰¹æ€§ï¼ˆå¦‚æ¶ˆæ¯åˆ†ç‰‡ã€ä¼˜å…ˆçº§ï¼‰ï¼Œéœ€è‡ªè¡Œå®ç°å¤æ‚é€»è¾‘ã€‚

------

**4. æœåŠ¡å™¨èµ„æºæ¶ˆè€—**

- **é•¿è¿æ¥å ç”¨èµ„æº**ï¼š
  æ¯ä¸ª SSE è¿æ¥ä¿æŒä¸€ä¸ªå¼€æ”¾çš„ HTTP è¯·æ±‚ï¼Œé«˜å¹¶å‘æ—¶å¯èƒ½å¯¼è‡´æœåŠ¡å™¨æ–‡ä»¶æè¿°ç¬¦è€—å°½ã€‚
- **æ— è¿æ¥å¤ç”¨**ï¼š
  ä¸åŒäº WebSocket çš„å•ä¸€è¿æ¥åŒå‘é€šä¿¡ï¼ŒSSE è‹¥éœ€å®¢æˆ·ç«¯ä¸Šä¼ æ•°æ®éœ€é¢å¤– HTTP è¯·æ±‚ã€‚

# SSEé‡Šæ”¾

åœ¨ **Server-Sent Events (SSE)** ä¸­ï¼Œ**æ¯ä¸ª SSE è¯·æ±‚éƒ½ä¼šå»ºç«‹ä¸€ä¸ªæŒä¹…çš„é•¿è¿æ¥**ï¼Œä½†ä¸ä¼šæ— é™å ç”¨æœåŠ¡å™¨èµ„æºã€‚ä¸‹é¢è¯¦ç»†è§£é‡Šå®ƒçš„**è¿æ¥ç®¡ç†æœºåˆ¶**å’Œ**èµ„æºé‡Šæ”¾é€»è¾‘**ï¼š

------

**1. é»˜è®¤è¡Œä¸ºï¼šSSE è¿æ¥æ˜¯æŒä¹…çš„**

- **å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚å**ï¼ŒæœåŠ¡å™¨ä¼šä¿æŒè¿™ä¸ª HTTP è¿æ¥å¼€æ”¾ï¼ˆ`Connection: keep-alive`ï¼‰ï¼Œå¹¶é€šè¿‡ `text/event-stream` æŒç»­æ¨é€æ¶ˆæ¯ã€‚
- **åªè¦è¿æ¥æœªä¸­æ–­**ï¼ŒæœåŠ¡å™¨å¯ä»¥ä¸€ç›´é€šè¿‡è¯¥è¿æ¥å‘é€æ•°æ®ï¼ˆä¾‹å¦‚ ChatGPT çš„é€å­—æµå¼å“åº”ï¼‰ã€‚

------

**2. è¿æ¥ä½•æ—¶æ–­å¼€ï¼Ÿ**

SSE è¿æ¥ä¼šåœ¨ä»¥ä¸‹æƒ…å†µä¸‹å…³é—­ï¼š

**ï¼ˆ1ï¼‰å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­**

- è°ƒç”¨ `EventSource.close()`ï¼š

  å‰ç«¯ä»£ç å¯ä»¥æ‰‹åŠ¨å…³é—­è¿æ¥ï¼š

  ```
  const es = new EventSource("/sse-endpoint");
  es.close(); // ä¸»åŠ¨æ–­å¼€
  ```

- **é¡µé¢å¸è½½**ï¼š
  å½“ç”¨æˆ·å…³é—­æ ‡ç­¾é¡µæˆ–è·³è½¬åˆ°å…¶ä»–é¡µé¢æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ç»ˆæ­¢ SSE è¿æ¥ã€‚

**ï¼ˆ2ï¼‰æœåŠ¡å™¨ä¸»åŠ¨å…³é—­**

- æœåŠ¡å™¨å‘é€ `[DONE]` æˆ–ç‰¹å®šä¿¡å·ï¼š

  ä¾‹å¦‚ ChatGPT åœ¨å›ç­”å®Œæˆåä¼šå‘é€ï¼š

  ```
  data: [DONE]
  ```

  å‰ç«¯å¯é€šè¿‡ç›‘å¬è¯¥äº‹ä»¶å…³é—­è¿æ¥ï¼š

  ```
  es.onmessage = (e) => {
    if (e.data === "[DONE]") es.close();
  };
  ```

- **æœåŠ¡å™¨ç»ˆæ­¢ HTTP è¿æ¥**ï¼š
  åç«¯å¯ä»¥ä¸»åŠ¨å…³é—­ TCP è¿æ¥ï¼ˆå¦‚ Node.js çš„ `response.end()`ï¼‰ã€‚