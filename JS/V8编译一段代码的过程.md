首先需要明白的是，机器是读不懂 JS 代码，机器只能理解特定的**机器码**，那如果要让 JS 的逻辑在机器上运行起来，就必须将 JS 的代码翻译成机器码，然后让机器识别。**JS属于解释型语言**，对于解释型的语言说，**解释器**会对源代码做如下分析:

- 通过**词法分析**和**语法分析**生成 **AST(**抽象语法树)
- 生成**字节码**

然后解释器根据字节码来执行程序。但 JS 整个执行的过程其实会比这个更加复杂，接下来就来一一地拆解。

## 生成 AST

生成 AST 分为两步——词法分析和语法分析。

### 词法分析

词法分析即分词，它的工作就是将一行行的代码分解成一个个token。 比如下面一行代码:

```js
let name = 'sanyuan'
```

![](http://47.98.159.95/my_blog/week07/7.jpg)

一行分解成这 4 个 token，这就是词法分析的作用。

### 语法分析

将生成的这些 token 数据，根据一定的语法规则转化为AST。举个例子:

```js
let name = 'sanyuan'
console.log(name)
```

最后生成的 AST 是这样的:

<img src="http://47.98.159.95/my_blog/week07/8.jpg" style="zoom: 80%;" />

当生成了 AST 之后，编译器/解释器后续的工作都要依靠 AST 而不是源代码。生成 AST 后，接下来会生成执行上下文，关于执行上下文，这几篇文章讲的还是很好的：

http://interview.poetries.top/browser/part2/lesson07.html#_1-%E7%BC%96%E8%AF%91%E9%98%B6%E6%AE%B5

## 生成字节码

生成 AST 之后，直接通过 **V8 的解释器**(也叫Ignition)来生成**字节码**。但是**字节码**并不能让机器直接运行，那你可能就会说了，不能执行还转成字节码干嘛，直接把 AST 转换成机器码不就得了，让机器直接执行。确实，在 V8 的早期是这么做的，但后来因为机器码的体积太大，引发了严重的内存占用问题。

很容易得出，字节码是比机器码轻量得多的代码。那 V8 为什么要使用字节码，字节码到底是个什么东西？

> 子节码是介于AST 和 机器码之间的一种代码，但是与特定类型的机器码无关，字节码需要通过解释器将其转换为机器码然后执行。

**字节码仍然需要转换为机器码，但和原来不同的是，现在不用一次性将全部的字节码都转换成机器码，而是通过解释器来逐行执行字节码，省去了生成二进制文件的操作，这样就大大降低了内存的压力。**

## 执行代码

在执行字节码的过程中，如果发现某一部分代码重复出现，那么 V8 将它记做`热点代码`(HotSpot)，然后将这么代码编译成**机器码**保存起来，这个用来编译的工具就是V8的**编译器**(也叫做`TurboFan`) , 因此在这样的机制下，代码执行的时间越久，那么执行效率会越来越高，因为有越来越多的字节码被标记为热点代码，遇到它们时直接执行相应的机器码，不用再次将转换为机器码。

**当听到有人说 JS 就是一门解释器语言的时候，严格来说这个说法是有问题的。因为字节码不仅配合了解释器，而且还和编译器打交道，所以 JS 并不是完全的解释型语言。而编译器和解释器的根本区别在于前者会编译生成二进制文件但后者不会。**

**并且，这种字节码跟编译器和解释器结合的技术，我们称之为即时编译, 也就是我们经常听到的`JIT`。**

## 总结

对 V8 中执行一段JS代码的整个过程，梳理一下:

1. 首先通过词法分析和语法分析生成 `AST`
2. 将 AST 转换为字节码
3. 由解释器逐行执行字节码，遇到热点代码启动编译器进行编译，生成对应的机器码, 以优化执行效率

## 参考文章

这里对编译和解释的区别做一些补充，可以参考这几篇文章

编译型语言在程序执行之前，需要经过**编译器**的编译过程，并且编译之后会直接保留机器能读懂的二进制文件，这样每次运行程序时，都可以直接运行该二进制文件，而不需要再次重新编译了。比如 C/C++、GO 等都是编译型语言。

而由解释型语言编写的程序，在每次运行时都需要通过**解释器**对程序进行动态解释和执行。比如 Python、JavaScript 等都属于解释型语言。

http://47.98.159.95/my_blog/js-v8/003.html#_1-%E7%94%9F%E6%88%90-ast

https://segmentfault.com/a/1190000013126460

http://interview.poetries.top/browser/part3/lesson14.html#%E7%BC%96%E8%AF%91%E5%99%A8%E5%92%8C%E8%A7%A3%E9%87%8A%E5%99%A8

https://zhuanlan.zhihu.com/p/96502646

